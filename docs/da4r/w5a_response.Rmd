---
title: "Responses to Week Five Assignment"
author: "Hiroshi Suzuki"
date: "`r Sys.Date()`"
output:
  html_notebook: 
    toc: yes
    toc_float: yes
---

## Week Five Assignment

Choose a data from UN data or OECD data.

-   Create an R Notebook of a data analysis containing the following and submit the rendered file (e.g., `w5_g123456.nb.html`) in Moodle.

    1.  Create an R Notebook using the R Notebook Template in Moodle and save it as, for example, `w5_g123456.Rmd`.

    2.  Edit author with name, ID, and title.

-   Contents should include the following:

    -   A short abstract

    -   Information of data including data name, description and link to reach the data

    -   Several charts: a bar graph or a column graph, a histogram, a line graph, a scatter plot

    -   Observations or questions for visualizations

-   Use left_join, if possible. (a challenge, not required)

-   Run each code block and preview to create, for example, `w5_g123456.nb.html`.

    -   Or, Run All under Run and Preview to check in your web browser!

    -   You can also view your file (e.g. `w5_g123456.nb.html`) by opening it from your web browser.

Submit your R Notebook file (w5_g123456.nb.html) in Moodle (Week Five Assignment).

***Due Sunday 28, January 2024, 11:59 PM***

# Your Project

## Title of your project

*The title can be in the title in YAML.*

### Short Abstract

We study .....

## Setup

Install a package `countrycode` first.

```{r}
library(tidyverse)
library(WDI)
library(readxl)
library(countrycode)
```


## Importing Data

## Viewing Data

## Visualization and Analysis

*Do not forget to add observations and questions.*


### About Data

#### List of Data Chosen:

1. WIR Executive Report: https://wir2022.wid.world/www-site/uploads/2022/03/WIR2022TablesFigures-Summary.xlsx
2. The world inequaluty report 2022 Executive Report F4: https://wir2022.wid.world/www-site/uploads/2022/03/WIR2022TablesFigures-Summary.xlsx
3. WID: World Inequality Database. The data sheet selected was data F4 [URL](https://wir2022.wid.world/www-site/uploads/2022/03/WIR2022TablesFigures-Summary.xlsx), UN Health Data
4.  UN population: https://data.un.org/_Docs/SYB/CSV/SYB66_246_202310_Population%20Growth,%20Fertility%20and%20Mortality%20Indicators.csv
5.  UN (FAO) palm oil: data attached UNdata_Export_20240128_153052531.csv
6.  UN Human resources in R & D: [Link](https://data.un.org/_Docs/SYB/CSV/SYB66_285_202310_Research%20and%20Development%20Staff%20and%20researchers%20in%20full%20time%20equivalent.csv) URL https://data.un.org/_Docs/SYB/CSV/SYB66_285_202310_Research%20and%20Development%20Staff%20and%20researchers%20in%20full%20time%20equivalent.csv
7.  UN Consumer Price Index, Employment: https://data.un.org/_Docs/SYB/CSV/SYB66_128_202310_Consumer%20Price%20Index.csv, https://data.un.org/_Docs/SYB/CSV/SYB66_200_202310_Employment.csv
8.  UN Population in the capital city, urban and rural areas: https://data.un.org/_Docs/SYB/CSV/SYB61_253_Population%20Growth%20Rates%20in%20Urban%20areas%20and%20Capital%20cities.csv
9.  UN (UNCHR): total number of forcibly displaced people [Link](https://data.un.org/Data.aspx?d=UNHCR&f=indID%3aType-Ref)
10. UN: gender gap in education:  https://data.un.org/_Docs/SYB/CSV/SYB66_319_202310_Ratio%20of%20girls%20to%20boys%20in%20education.csv
11. UN: urbanization (Capital city population (thousands)
Urban population (percent growth rate per annum)
Rural population (percent growth rate per annum))
12. UN: Anthracite - commerce and public services
13. UN Data - Government expenditure on education as % of GDP: [Link](https://data.un.org/Data.aspx?q=education+expenditure&d=UNESCO&f=series%3aXGDP_FSGOV), UN Data - Gross Enrolment Ratio - Tertiary Education: [Link](https://data.un.org/Data.aspx?q=tertiary&d=GenderStat&f=inID%3a65)
14. Ease of doing business (EODB) score [Link]( https://data.un.org/Data.aspx?d=WDI&f=Indicator_Code%3aIC.BUS.DFRN.XQ), CPIA business regulatory environment rating [Link](https://data.un.org/Data.aspx?q=cpia&d=WDI&f=Indicator_Code%3aIQ.CPA.BREG.XQ)
15.  OECD CIP country weight:  https://data-explorer.oecd.org/vis?fs[0]=Topic%2C0%7CEconomy%23ECO%23&fs[1]=Topic%2C1%7CEconomy%23ECO%23%7CPrices%23ECO_PRI%23&pg=0&fc=Topic&snb=16&df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_CPI_COU_WEIGHTS%40DF_CPI_CTRY_WEIGHTS&df[ag]=OECD.SDD.TPS&df[vs]=1.0&pd=%2C&dq=.A..&ly[rw]=REF_AREA&ly[cl]=TIME_PERIOD&to[TIME_PERIOD]=false&lo=5&lom=LASTNPERIODS
16.  OECD: Venture capital investments (market statistics), Gross domestic product (GDP)
17.  OECD: https://data-explorer.oecd.org/vis?fs[0]=Topic%2C1%7CSociety%23SOC%23%7CWell-being%20and%20beyond%20GDP%23SOC_WEL%23&pg=0&fc=Topic&bp=true&snb=2&vw=tb&df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_CWB%40DF_CWB&df[ag]=OECD.WISE.CWB&df[vs]=1.0&pd=2018%2C2018&dq=.A4_3%2BA4_2%2BA4_6.A4&ly[cl]=MEASURE&ly[rw]=REF_AREA&to[TIME_PERIOD]=false
18. OECD: Tertiary graduation rate of women (PhD graduation, women) [Link]( https://data.oecd.org/students/tertiary-graduation-rate.htm)
19. OECD: Tax on personal income  [Link](https://stats.oecd.org/sdmx-json/data/DP_LIVE/.TAXINCOME.TOT.PC_GDP.A/OECD?contentType=csv&detail=code&separator=comma&csv-lang=en&startPeriod=2000)
20. OECD: “ICT Access and Usage by Individuals” [URL CSV](https://sdmx.oecd.org/public/rest/data/OECD.STI.STP,DSD_MSTI@DF_MSTI,1.1/.A.G.PT_B1GQ..?startPeriod=2014&dimensionAtObservation=AllDimensions&format=csvfilewithlabels), “Main Science and Technology Indicators” [URL Excel](https://datacatalogfiles.worldbank.org/ddh-published/0037712/DR0090755/CLASS.xlsx)
21. OECD: fluctuations by analyzing the catch files:
22. OECD Child Well-Being: [Link](https://data-explorer.oecd.org/vis?fs[0]=Topic%2C1%7CSociety%23SOC%23%7CWell-being%20and%20beyond%20GDP%23SOC_WEL%23&pg=0&fc=Topic&bp=true&snb=2&vw=tb&df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_CWB%40DF_CWB&df[ag]=OECD.WISE.CWB&df[vs]=1.0&pd=2018%2C2018&dq=.A4_3%2BA4_2%2BA4_6.A4&ly[cl]=MEASURE&ly[rw]=REF_AREA&to[TIME_PERIOD]=false)


# Examples

## UN Data on Education

*Let me illustrate steps using the following indicators. Issues are not taken from the analysis of the one who chose these indicators.*

1.  UN Data - Government expenditure on education as % of GDP: [Link](https://data.un.org/Data.aspx?q=education+expenditure&d=UNESCO&f=series%3aXGDP_FSGOV), 

2.  UN Data - Gross Enrollment Ratio - Tertiary Education: [Link](https://data.un.org/Data.aspx?q=tertiary&d=GenderStat&f=inID%3a65)

*When download the data, choose country codes from 'Select columns'. The first data adds iso3c codes and the second adds UN number codes.*

*It is helpful to add links to the site.*

### Set up

```{r}
library(tidyverse)
```

*Create data folder if you do not have it under Files.*

```{r eval=FALSE}
dir.create("data")
```

*If you do not have `wdicache.rds` in your data folder, run the following two code chunks.*

```{r wdicache, eval=FALSE}
wdicache <- WDIcache()
```

```{r writewdicache, eval=FALSE, echo=FALSE}
write_rds(wdicache, "data/wdicache.rds")
```

```{r readwdicache, echo=FALSE}
wdicache <- read_rds("data/wdicache.rds")
```

```{r}
wdi_country_extra <- wdicache$country |> select(iso3c, region, income, lending)
```

### Information of Data


### Importing Data

Go to the [data link](https://data.un.org/Data.aspx?q=education+expenditure&d=UNESCO&f=series%3aXGDP_FSGOV). Add Reference Area Code from Select column on top. Click Update. You will see that iso3c is added in the first column. Then download a CSV file (Comma). You get 'UNdata_Export_20240131_024758033.csv'.

Next go the the [data link](https://data.un.org/Data.aspx?q=tertiary&d=GenderStat&f=inID%3a65). Similarly, add Country or Area Code from Select column on top. Click Update. You will see that UN code is added in the first column. Then download a CSV file (Comma). You get 'data/UNdata_Export_20240131_024820801.csv'.

Place the downloaded data 'UNdata_Export_20240131_024758033.csv' and 'UNdata_Export_20240131_024820801.csv' in the data folder.

```{r}
df_ed_gov_exp <- read_csv("data/UNdata_Export_20240131_024758033.csv")
df_ed_gov_exp
```

```{r}
df_ed_gov_exp |> str()
```

**Observation**

- There are seven columns.
- The first column 'Reference Area Code' is 'iso3c'.
- The second column 'Reference Area' seems to be the country name.
- The third column 'Time Period' is year. It is in `dbl`, and should be in `integer`.
- The fourth column, 'Sex' start with "Not applicable". Probably, male and female will appear.
- The fifth column, 'Age group' start with "Not applicable". 
- The sixth column, 'Units of measurement' starts with "Percent".
- The seventh column, 'Observation Value' should be numbers reprenting the percent of GDP.

#### Check the categorical variables

Select the categorical vaiables we want to check the values.

```{r}
df_ed_gov_exp |> select(`Time Period`, Sex, `Age group`, `Units of measurement`) |> lapply(unique)
```

We do not need the categorical variable with only one value.

With 'select' we can change the names of the variables as well. Change `Time Period` to integer values. Then delete `Time Period` column. We do not need quotation marks for column names, but if there is a space in the column name, we need to surround by ` ` back ticks.

```{r}
df_gov_exp <- df_ed_gov_exp |> 
  select(iso3c = `Reference Area Code`, country = `Reference Area`, `Time Period`, gov_exp = `Observation Value`) |> mutate(year = as.integer(`Time Period`), .after = country) |> 
  select(-`Time Period`) |> arrange(country, iso3c, year)
df_gov_exp
```

Now, we reached a clean data. We do the same to the second data.

```{r}
df_tertiary_ratio <- read_csv("data/UNdata_Export_20240131_024820801.csv")
df_tertiary_ratio
```

```{r}
df_tertiary_ratio |> str()
```

Besides the ones we noticed in the first data, surprisingly, the Value is in character. Let me check.

```{r}
df_tertiary_ratio$Value |> unique()
```

We can assume that these are numbers.

```{r}
df_tertiary_ratio |> select(Subgroup, Year, Source, Unit, `Value Footnotes`) |> lapply(unique)
```

```{r}
df_tertiary <- df_tertiary_ratio |> select(un_code = `Country or Area Code`, country = `Country or Area`, sex = Subgroup, Year, tertiary = Value) |> mutate(year = as.integer(Year), .before = sex, tertiary = as.numeric(tertiary)) |> select(-Year)
df_tertiary
```

Here, we check the list of countries in two data sets.

```{r}
setdiff(unique(df_gov_exp$country), unique(df_tertiary$country))
```

```{r}
setdiff(unique(df_tertiary$country), unique(df_gov_exp$country))
```

We can observe that many country names do not agree. 

**Country Names are different.**

Next check, if we can properly assign `iso3c` to the second data. 
The following shows that excep the 8 countries below, `iso3c` are assigned. 

```{r}
df_tertiary |> 
  mutate(iso3c = countrycode(country, "country.name", "iso3c"), .after = un_code) |> 
  filter(is.na(iso3c)) |> distinct(country)
```

Check whether two countries appear in the first data.

```{r}
df_gov_exp |> filter(country %in% c("Netherlands Antilles", "Serbia and Montenegro"))
```

Let us assign `iso3c` and delete the rows which we cannot assign `iso3c`.

```{r}
df_tertiary1 <- df_tertiary |> 
  mutate(iso3c = countrycode(country, "country.name", "iso3c"), .after = un_code) |> 
  select(-country, -un_code) |> filter(!is.na(iso3c))
df_tertiary1
```

Now we combine these two datasets. We reached a reasonably clean combined dataset.

```{r}
df_un_ed_combined <- df_gov_exp |> full_join(df_tertiary1, by = c("iso3c", "year"))
df_un_ed_combined
```

### Five chosen counries' government expendicure on education

```{r}
df_un_ed_combined |> filter(country %in% c("Japan", "Viet Nam", "China", "Republic of Korea", "United States of America")) |> drop_na(gov_exp) |>
  ggplot(aes(year, gov_exp, col = country)) + geom_line() +
  labs(title = "Five Countries' Goverment Expenditure on Education")
```

```{r}
df_un_ed_combined |> filter(country %in% c("Japan", "Viet Nam", "China", "Republic of Korea", "United States of America")) |> drop_na(tertiary)
```

### Five counrties' tertiary educaton enrolement

```{r}
df_un_ed_combined |> filter(country %in% c("Japan", "Viet Nam", "China", "Republic of Korea", "United States of America")) |> drop_na(tertiary) |>
  ggplot(aes(year, tertiary, col = country, linetype = sex)) + geom_line()
```

```{r}
df_un_ed_combined |> filter(country %in% c("Japan", "Viet Nam", "China", "Republic of Korea", "United States of America")) |> drop_na(tertiary) |>
  ggplot(aes(year, tertiary, col = country, linetype = sex)) + geom_line() + 
  scale_y_log10() + labs(title = "Gross Enrolment Ratio in Tertiary Education", subtitle = "Log 10 Scale in Number")
```

### Combine wdicache

```{r}
df_un_ed_combined_ext <- df_un_ed_combined |> left_join(wdi_country_extra, by = 'iso3c')
df_un_ed_combined_ext
```

## Human resources in Research and Development

### Preparation

```{r}
wdicache <- read_rds("data/wdicache.rds")
wdi_country_extra <- wdicache$country |> select(iso2c, region, income)
```

```{r}
INCOME <- c("High income", "Upper middle income", "Lower middle income", "Low income")
```

```{r}
BRICS <- c("Brazil", "Russian Federation", "India", "China", "South Africa")
```

```{r}
G7 <- c("Canada", "France", "Germany", "Italy", "Japan", "United Kingdom", "United States")
```

### Importing Data

```{r}
url_un_R_D <- "https://data.un.org/_Docs/SYB/CSV/SYB66_285_202310_Research%20and%20Development%20Staff%20and%20researchers%20in%20full%20time%20equivalent.csv"
```

```{r}
df_un_R_D <- read_csv(url_un_R_D, skip = 1)
```

```{r}
df_un_R_D
```

```{r}
str(df_un_R_D)
```

```{r}
df_un_R_D |> select(Series, Footnotes, Source) |> lapply(unique)
```

Add iso2c code, and check those the names listed in ...2 whose iso2c_un is NA.
From the output, these are all region names. So in the next code, we delete them.

```{r}
library(countrycode)
```


```{r}
df_un_R_D_region <- df_un_R_D |> 
  mutate(iso2c = countrycode(`Region/Country/Area`, "un", "iso2c"), .after = ...2) |>
  filter(is.na(iso2c)) 
df_un_R_D_region |> distinct(...2)
```

```{r}
df_un_R_D |> 
  mutate(iso2c = countrycode(`Region/Country/Area`, "un", "iso2c"), .after = ...2) |>
  filter(!is.na(iso2c)) |> 
  select(country = ...2, iso2c, year = Year, series = Series, value = Value) |>
  pivot_wider(names_from = series, values_from = value)
```

The following is another way of renaming series names, an alternative to use mutate-case_when.
The operation `pivot_wider` is the converse operation to `pivot_longer`.

The units of two indicators are different. One is in percent of GDP, and the other is the number of researchers in one million inhabitants. So it is better to handle the data in wide format instead of that in long data. 

```{r}
df_R_D_wide <- df_un_R_D |> 
  mutate(iso2c = countrycode(`Region/Country/Area`, "un", "iso2c"), .after = ...2) |>
  filter(!is.na(iso2c)) |> 
  select(country = ...2, iso2c, year = Year, series = Series, value = Value) |>
  pivot_wider(names_from = series, values_from = value) |>
  rename(rd_exp = `Gross domestic expenditure on R&D: as a percentage of GDP`, researcher = `Researchers per million inhabitants (FTE)`)
df_R_D_wide
```

```{r}
df_R_D_region_wide <- df_un_R_D_region |> select(country = ...2, year = Year, series = Series, value = Value) |>
  pivot_wider(names_from = series, values_from = value) |>
  rename(rd_exp = `Gross domestic expenditure on R&D: as a percentage of GDP`, researcher = `Researchers per million inhabitants (FTE)`)
df_R_D_region_wide
```

```{r}
df_R_D_wide_extra <- df_R_D_wide |> left_join(wdi_country_extra, by = "iso2c")
df_R_D_wide_extra
```

```{r}
df_R_D_extra <- df_R_D_wide_extra |> pivot_longer(cols = c(rd_exp, researcher))
df_R_D_extra
```

It is important to check the number of data in each year.

```{r}
df_R_D_extra |> drop_na(value) |> 
  ggplot(aes(year, fill = name)) + geom_bar() + labs(title = "Count of data")
```

```{r}
df_R_D_wide_extra |> drop_na(rd_exp, researcher) |>
  ggplot(aes(rd_exp, researcher, col = income)) + geom_point() +
  labs(title = "Scatterplot: Expenditure on R&D vs Researchers per million", subtitle = "by income level")
```

```{r}
df_R_D_wide_extra |> drop_na(rd_exp, researcher) |>
  ggplot(aes(rd_exp, researcher, col = region)) + geom_point() +
  labs(title = "Scatterplot: Expenditure on R&D vs Researchers per million", subtitle = "by region")
```

```{r}
df_R_D_wide_extra |> drop_na(rd_exp, researcher) |> lm(researcher ~ rd_exp, data = _) |>
  summary()
```

```{r}
df_R_D_wide_extra |> drop_na(rd_exp, researcher) |> select(rd_exp, researcher) |> cor()
```

The value is the square root of the multiple R-squared above. There variables are strongly positively correlated.


```{r}
df_R_D_wide_extra |> filter(year %in% c(2005, 2010, 2015, 2020)) |> drop_na(rd_exp) |>
  filter(income %in% INCOME) |>
  ggplot(aes(factor(income, levels = INCOME), rd_exp)) + geom_boxplot() + 
  labs(title = "Gross domestic expenditure on R&D: % of GDP by income level", x = "", y = "expenditure on R&D" )
```

```{r}
df_R_D_wide_extra |> filter(year %in% c(2005, 2010, 2015, 2020)) |> drop_na(researcher) |>
  filter(income %in% INCOME) |>
  ggplot(aes(factor(income, levels = INCOME), researcher)) + geom_boxplot() + 
  labs(title = "Researchers per million inhabitants (FTE) by income level", x = "")
```

```{r}
df_R_D_wide_extra |> filter(year %in% c(2005, 2010, 2015, 2020)) |> drop_na(rd_exp) |>
  ggplot(aes(region, rd_exp)) + geom_boxplot() + coord_flip() + 
  labs(title = "G7 countries: Gross domestic expenditure on R&D: % of GDP ", x = "", y = "expenditure on R&D")
```

```{r}
df_R_D_wide_extra |> filter(year %in% c(2005, 2010, 2015, 2020)) |> drop_na(researcher) |>
  ggplot(aes(region, researcher)) + geom_boxplot() + coord_flip() + 
  labs(title = "Researchers per million inhabitants (FTE) by region", x = "")
```

```{r}
df_R_D_wide_extra |> filter(country %in% G7) |> drop_na(rd_exp) |>
  ggplot(aes(year, rd_exp, col = country)) + geom_line() + 
  labs(title = "G7 countries: Gross domestic expenditure on R&D: % of GDP ", y = "expenditure on R&D")
```

```{r}
df_R_D_wide_extra |> filter(country %in% BRICS) |> drop_na(rd_exp) |>
  ggplot(aes(year, rd_exp, col = country)) + geom_line() + 
  labs(title = "BRICS countries: Gross domestic expenditure on R&D: % of GDP ",y = "expenditure on R&D")
```

```{r}
df_R_D_wide_extra |> filter(country %in% G7) |> drop_na(researcher) |>
  ggplot(aes(year, researcher, col = country)) + geom_line()  + 
  labs(title = "G7 countries: Researchers per million inhabitants (FTE)")
```

```{r}
df_R_D_wide_extra |> filter(country %in% BRICS) |> drop_na(researcher) |>
  ggplot(aes(year, researcher, col = country)) + geom_line() + 
  labs(title = "BRICS countries: Researchers per million inhabitants (FTE)")
```

```{r}
df_R_D_region_wide |> distinct(country)
```

```{r}
df_R_D_region_wide |> drop_na(rd_exp) |>
  filter(!(country %in% c("Total, all countries or areas", "Australia and New Zealand", "LLDCs", "LDC\xa7", "SIDS"))) |> ggplot(aes(year, rd_exp, col = country)) + geom_line() +
  labs(title = "Gross domestic expenditure on R&D: % of GDP by region")
```

```{r}
df_R_D_region_wide |> drop_na(researcher) |>
  filter(!(country %in% c("Total, all countries or areas", "Australia and New Zealand", "LLDCs", "LDC\xa7", "SIDS"))) |> ggplot(aes(year, researcher, col = country)) + geom_line() +
  labs(title = "Researchers per million inhabitants (FTE) by region")
```

