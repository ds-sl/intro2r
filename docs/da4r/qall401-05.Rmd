---
title: "Data Analysis for Researchers 2023, Week 5"
author: "Hiroshi Suzuki"
date: "2024/01/24"
output:
  html_notebook: default
  html_document:
    df_print: paged
  ioslides_presentation:
    widescreen: yes
---

# Part I: EDA with Public Data

## Preview

-   Week 5, Jan. 24: EDA4, UN, OECD, readr, readxl, two table verbes, modeling

-   Week 6, Jan. 31: EDA5, Round-up, communication, pdf, Word, PowerPoint

### Review

-   Responses to Week Four Assignment: [[Link](https://ds-sl.github.io/intro2r/da4r/w4a_response.nb.html)]

    -   long table

    -   [Option] choropleth map

------------------------------------------------------------------------

### Directory and Folder

*Q. Explain the difference between the directory and the folder of PC briefly.*

*A. by Bard.*

Here's a brief explanation of the differences between directories and folders on a PC:

Directory (Technical Term):

-   Fundamental file system structure: It's the way your computer organizes files and folders in a hierarchical structure.

-   Can contain files, subdirectories, and even other directories.

-   Abstract concept: It's not directly visible in graphical user interfaces (GUIs) like Windows Explorer.

-   Referred to in command-line interfaces (CLIs) like the Terminal.

------------------------------------------------------------------------

Folder (Visual Metaphor):

-   Graphical representation of a directory: It's the icon you see in your file explorer.

-   User-friendly way to interact with directories: It allows you to create, move, rename, and delete them.

-   May contain files and other folders (subfolders).

-   Common term in GUIs: It's what most people interact with on a daily basis.

Key Points:

-   Directories are the underlying structure, while folders are visual representations.

-   They're often used interchangeably in casual conversation.

-   Technical discussions often use "directory" for accuracy.

-   Both terms refer to a way to organize files on your computer.

------------------------------------------------------------------------

### Where are you in R? - Working Directories in Your Project

-   The directory of a folder and a file under Files:

    -   Shown under Files starting from a house icon.

-   Working directory of your project:

    -   Run `getwd()` in Console.

-   Working directory of your RNotebook:

    -   Run `getwd()` in a code chunk.

    -   The directory your *`file_name.Rmd`* and *`file_name.nb.html`* is.

-   Confirm `data` folder is in the working directory of your RNotebook.

```{r eval = FALSE}
getwd()
```

`[1] "/Users/hsuzuki/Documents/QALL401"`

------------------------------------------------------------------------

### R System Command

-   Menu: File, Tools: Install Packages, Check for Package Update, Keyboard Shortcut Help, Help: Cheat Sheet, Markdown Quick Reference

-   Panes: Source/Visual, Console, Environment tab, History tab, Files, tab, Packages, Help

-   Sys.setenv(LANG = "en") (Sys.setenv(LANG = "ja"))

-   data(): loaded data

-   ls(): list objects (Environment)

-   [Ctrl] + L (\^L. Under Edit, Clear Console): clear console

-   rm(chosen_indicator_1): remove an object

-   rm(list = ls()): remove all

## Importing Data

### Data Location

-   Internet link: URL

    -   link of the webpage, other information

    -   `download.files(url, destifile = "data/name_of_data.XXX", mode = "wb")`

        -   `mode = "wb"` for digital files

        -   .XXX: extenstions; csv, tsv, xls, xlsx

-   `data` folder: downloaded or created data

    -   link of the webpage, other information

#### Reproducibility

Keep a record of the data to communicate with others.

------------------------------------------------------------------------

### File Types

-   Text file: CSV, etc

-   Digital file: Excel, etc

-   Other: archived compressed file, json, etc.

    -   unzip or expand first

    -   may contain many files; data, metadata, readme, etc.

------------------------------------------------------------------------

### **Importing text data**

-   `readr`: a part of `tidyverse`

    -   [`read_csv()`](https://readr.tidyverse.org/reference/read_delim.html): comma-separated values (CSV)

    -   [`read_tsv()`](https://readr.tidyverse.org/reference/read_delim.html): tab-separated values (TSV)

    -   [`read_csv2()`](https://readr.tidyverse.org/reference/read_delim.html): semicolon-separated values with `,` as the decimal mark

    -   [`read_delim()`](https://readr.tidyverse.org/reference/read_delim.html): delimited files (CSV and TSV are important special cases)

    -   [`read_fwf()`](https://readr.tidyverse.org/reference/read_fwf.html): fixed-width files

    -   [`read_table()`](https://readr.tidyverse.org/reference/read_table.html): whitespace-separated files

    -   [`read_log()`](https://readr.tidyverse.org/reference/read_log.html): web log files

    -   e.g. `df_name <- read_csv("data/datafile.csv")`

-   Reference [[readr site](https://readr.tidyverse.org/)] [[CheatSheet](https://rstudio.github.io/cheatsheets/html/data-import.html)]

------------------------------------------------------------------------

### **Excel files (xls, xlsx)**

-   readxl: a part of tidyverse but you need to load by [`library(readxl)`](https://readxl.tidyverse.org/) 

    -   `df_name <- read_excel("./data/datafile.xlsx")`

    -   `read_xls` and `read_xlsx` are available

    -   `sheet = 2`, or `sheet = "name"` See Help.

-   Import datasets of RStudio

-   Reference

    -   [readxl](https://readxl.tidyverse.org/) 

    -   Data Importing CheatSheet [[Link](https://rstudio.github.io/cheatsheets/html/data-import.html)]

------------------------------------------------------------------------

### **Download data file**

-   text file (csv, etc.)

    -   `download.file(url = "URL", destfile = "./data/file_name.csv")`

    -   `df_name <- read_csv(URL)`

        -   `write_csv(df_name, "./data/df_name.csv")`

        -   `df_name <- read_csv("./data/df_name.csv")`

-   digital file (Excel)：`download.file(url = "URL", destfile = "./data/file_name.xlsx", mode = "wb")`

```{r eval=TRUE, echo=FALSE, message = FALSE}
library(tidyverse)
```

## Two Tables Verbs

**Cheet Sheet: Data transformation with dplyr** See the second page of PDF [[Link](https://rstudio.github.io/cheatsheets/html/data-transformation.html)]

-   `left_join(x,y)`: includes all rows in x.

    -   `df_wdi_gdp |> left_join(wdicache, by = iso2c)`

    -   `df_un_data |> left_join(df_wdi_data, by = c("un_iso2c" = "iso2c")`

    -   `df_owid_data |> left_join(df_wdi_data, by = c("region" = "country")`

-   `anti_join(x,y, ...)`: return all rows from x without a match in y.

-   `semi_join(x,y, ...)`: return all rows from x with a match in y.

------------------------------------------------------------------------

### **Need a key to combine with `by` option**

An example

```         
library(countrycode)
df_un_data %>% mutate(iso2c_un = countrycode(`Region/Country/Area`, "un", "iso2c"), 
  .after = ...2)
```

# Part II: Practicum

## File Links

-   Public Data [[Link](https://ds-sl.github.io/intro2r/da4r/public_data.nb.html)], [[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/da4r/public_data.Rmd)]

-   Week Five Assignment Template [[Link](https://ds-sl.github.io/intro2r/da4r/w5_assignment_template.nb.html)], [[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/da4r/w5_assignment_template.Rmd)]

## Week Five Assignment

Choose a data from UN data or OECD data.

-   Create an R Notebook of a data analysis containing the following and submit the rendered file (e.g., `w5_g123456.nb.html`) in Moodle.

    1.  Create an R Notebook using the R Notebook Template in Moodle and save it as, for example, `w5_g123456.Rmd`.

    2.  Edit author with name, ID, and title.

------------------------------------------------------------------------

-   Contents should include the following:

    -   A short abstract

    -   Information of data including data name, description and link to reach the data

    -   Several charts: a bar graph or a column graph, a histogram, a line graph, a scatter plot

    -   Observations or questions for visualizations

-   Use left_join, if possible. (a challenge, not required)

------------------------------------------------------------------------

-   Run each code block and preview to create, for example, `w5_g123456.nb.html`.

    -   Or, Run All under Run and Preview to check in your web browser!

    -   You can also view your file (e.g. `w5_g123456.nb.html`) by opening it from your web browser.

Submit your R Notebook file (w5_g123456.nb.html) in Moodle (Week Five Assignment).

***Due Sunday 28, January 2024, 11:59 PM***


## World Inequality Database

<https://wid.world>

### World Inequality Report 2022

-   World Inequality Report 2022: <https://wir2022.wid.world>

-   Methodology [[Link](https://wir2022.wid.world/methodology/)]

```{r}
url_summary <- "https://wir2022.wid.world/www-site/uploads/2022/03/WIR2022TablesFigures-Summary.xlsx"
download.file(url = url_summary, destfile = "data/WIR2022s.xlsx", mode = "wb")
```

------------------------------------------------------------------------

```{r}
library(readxl) # readxl is a part of tidyverse but not a core package
```

```{r}
excel_sheets("data/WIR2022s.xlsx")
```

------------------------------------------------------------------------

```{r}
df_wir_f2 <- read_excel("data/WIR2022s.xlsx", 
    sheet = "data-F2")
df_wir_f2
```

------------------------------------------------------------------------

Created a new Excel book with only one sheet, and save it as a CSV UTF-8.

```{r}
df_wir_f2_2 <- read_csv("data/wir-f2.csv")
df_wir_f2_2
```

------------------------------------------------------------------------

```{r}
df_wir_f2_2 |> identical(df_wir_f2)
```

```{r eval=FALSE}
df_wir_f2_3 <- read_delim(clipboard())
df_wir_f2_3
```

------------------------------------------------------------------------

```{r}
df_wir_f2 |> pivot_longer(3:5) |> 
  ggplot(aes(iso, value, fill = name)) + geom_col(position = "dodge") + coord_flip()
```

------------------------------------------------------------------------

See: <https://ds-sl.github.io/data-analysis/wir2022.nb.html>

### To share data with someone else.

```{r}
df_wir_dput <- dput(df_wir_f2)
df_wir_dput
```

```{r}
df_wir_f2_3 <- df_wir_dput
df_wir_f2_3 |> identical(df_wir_f2)
```

## UNdata - a world of information

<https://data.un.org/>

Popular statistical tables

Explorer - datamarts: <http://data.un.org/Explorer.aspx>

-   Datasets, Sources, Topics

### Popular statistical tables

Copy the link of International Migrants and Refugees

```{r}
un_migrants_url <- "https://data.un.org/_Docs/SYB/CSV/SYB66_327_202310_International%20Migrants%20and%20Refugees.csv"
download.file(un_migrants_url, destfile = "data/migrants.csv")
```

------------------------------------------------------------------------

```{r}
df_un_migrants <- read_csv("data/migrants.csv")
df_un_migrants
```

------------------------------------------------------------------------

```{r}
df_un_migrants <- read_csv("data/migrants.csv", skip=1)
df_un_migrants
```

------------------------------------------------------------------------

### Explorer - datamarts

Environment Statistics Database\>Water\>Internal flow [[Link](http://data.un.org/Data.aspx?d=ENV&f=variableID:5&c=2,3,4,5&s=countryName:asc,yr:desc&v=1)]

```{r}
df_un_water <- read_csv("data/UNdata_Export_20240124_010609671.csv")
df_un_water
```

```{r}
url_un_migrants <- "https://data.un.org/_Docs/SYB/CSV/SYB66_327_202310_International%20Migrants%20and%20Refugees.csv"
```

```{r}
df_un_migrants <- read_csv(url_un_migrants, skip = 1)
df_un_migrants
```

```{r}
str(df_un_migrants)
```

------------------------------------------------------------------------

<!-- ### Download data -->

<!-- ```{r} -->

<!-- download.file(url_un_migrants, destfile = "data/un_migrants.csv") -->

<!-- ``` -->

```{r}
df_un_migrants |> summary()
```

```{r}
df_un_migrants |> select(Year,Series) |> lapply(unique)
```

```{r eval = FALSE}
df_un_migrants |> distinct(`Region/Country/Area`, ...2)
```

------------------------------------------------------------------------

```{r}
library(countrycode)
df_un_migrants %>% mutate(iso2c_un = countrycode(`Region/Country/Area`, "un", "iso2c"), .after = ...2)
```

------------------------------------------------------------------------

```{r}
df_un_migrants |> mutate(iso2c_un = countrycode(`Region/Country/Area`, "un", "iso2c"), .after = ...2) |> filter(is.na(iso2c_un)) |> distinct(...2)
```

------------------------------------------------------------------------

```{r}
wdicache <- read_rds("data/wdicache.rds")
wdi_country_extra <- wdicache$country |> select(iso2c, region, income, lending)
```

```{r eval=FALSE}
df_un_migrants_ext <- df_un_migrants %>% 
  mutate(iso2c_un = countrycode(`Region/Country/Area`, "un", "iso2c"), .after = ...2) |>
  drop_na(iso2c_un) |> 
  select(Country = ...2, ISO2C = iso2c_un, Year, Series, Value, Footnotes) |>
  left_join(wdi_country_extra, by = c("ISO2C" = "iso2c"))
df_un_migrants_ext
```

------------------------------------------------------------------------

```{r echo=FALSE}
df_un_migrants_ext <- df_un_migrants %>% 
  mutate(iso2c_un = countrycode(`Region/Country/Area`, "un", "iso2c"), .after = ...2) |>
  drop_na(iso2c_un) |> 
  select(Country = ...2, ISO2C = iso2c_un, Year, Series, Value, Footnotes) |>
  left_join(wdi_country_extra, by = c("ISO2C" = "iso2c"))
df_un_migrants_ext
```

------------------------------------------------------------------------

```{r}
df_un_migrants_ext$Series |> unique()
```

------------------------------------------------------------------------

```{r}
df_un_migrants_ext_rev <- df_un_migrants_ext |> mutate(Ser = case_when(
  Series == "International migrant stock: Both sexes (number)" ~ "migrant",
  Series == "International migrant stock: Both sexes (% total population)" ~ "migrant_percent",
  Series == "International migrant stock: Male (% total Population)" ~ "migrant_male",
  Series == "International migrant stock: Female (% total Population)" ~ "migrant_female",
  Series == "Total refugees and people in refugee-like situations (number)" ~ "refugee",
  Series == "Asylum seekers, including pending cases (number)" ~ "asylum",
  Series == "Other of concern to UNHCR (number)"  ~ "other",
  Series == "Total population of concern to UNHCR (number)" ~ "concern",
  TRUE ~ Series), .before = Series)
```

------------------------------------------------------------------------

```{r}
df_un_migrants_ext_rev
```

```{r eval=FALSE}
dput(df_un_migrants_ext_rev)
```

## OECD data

<https://data.oecd.org/>

Database Access: <https://data-explorer.oecd.org/>

### Expenditure on educational institutions per full-time equivalent student

[[Link](https://data-explorer.oecd.org/vis?fs%5B0%5D=Topic%2C0%7CEducation%23EDU%23&pg=0&fc=Topic&bp=true&snb=34&vw=tb&df%5Bds%5D=dsDisseminateFinalDMZ&df%5Bid%5D=DSD_EAG_UOE_FIN%40DF_UOE_INDIC_FIN_PERSTUD&df%5Bag%5D=OECD.EDU.IMEP&df%5Bvs%5D=1.0&pd=2020%2C2020&dq=..ISCED11_1%2BISCED11_2%2BISCED11_3%2BISCED11_34%2BISCED11_35%2BISCED11_4%2BISCED11_5%2BISCED11_5T8%2BISCED11_6T8%2BISCED11_1T8._T.INST_EDU.DIR_EXP..&ly%5Brw%5D=REF_AREA&ly%5Bcl%5D=EDUCATION_LEV&to%5BTIME_PERIOD%5D=true)]

Table in Excel, Filtered data in tableau text (CSV), Unfiltered data in tableau text (CSV) 136.4MB

```{r}
temp <- read_csv("../../../bigdata/OECD.EDU.IMEP,DSD_EAG_UOE_FIN@DF_UOE_INDIC_FIN_PERSTUD,1.0+all.csv")
temp
```

------------------------------------------------------------------------

```{r}
library(readxl)
df_oecd_ed <- read_excel("data/OECD.EDU.IMEP,DSD_EAG_UOE_FIN@DF_UOE_INDIC_FIN_PERSTUD,1.0,filtered,2024-01-24 10-22-31.xlsx")
```

```{r}
df_oecd_ed
```

------------------------------------------------------------------------

```{r}
df_oecd_ed <- read_excel("data/OECD.EDU.IMEP,DSD_EAG_UOE_FIN@DF_UOE_INDIC_FIN_PERSTUD,1.0,filtered,2024-01-24 10-22-31.xlsx", skip = 6) |> drop_na(3)
df_oecd_ed
```

## Modeling

-   searching models: few numbers

-   linear regression

```{r}
cars
```

------------------------------------------------------------------------

```{r}
cars |> ggplot(aes(dist, speed)) + geom_point() + 
  geom_smooth(formula = 'y ~ x', method = "lm", se=FALSE)
```

------------------------------------------------------------------------

```{r}
cars |> lm(dist ~ speed, data = _) |> summary()
```

<!-- ### Examples -->

<!-- -   gini, s80/s20 -->

## References

-   Data Analysis for Researchers. [[Link](https://icu-hsuzuki.github.io/da4r/)]

-   H. Wickham. *R for Data Science (2e)*. [[Link](https://r4ds.hadley.nz)]・[[O'REILLY](https://www.oreilly.com/library/view/r-for-data/9781492097396/)].

    -   Data transformation [[Link](https://r4ds.hadley.nz/data-transform)]

    -   Data tidying [[Link](https://r4ds.hadley.nz/data-tidy)]

    -   Data import [[Link](https://r4ds.hadley.nz/data-import)]

    -   Import [[Link](https://r4ds.hadley.nz/import)]

-   Posit Recipes（New edition of Posit Primers）: interactive exercises [[Link](https://posit.cloud/learn/recipes)]

-   Cheat Sheet. [[Site Link](https://rstudio.github.io/cheatsheets/)]

    -   Data import with the tidyverse [[Link](https://rstudio.github.io/cheatsheets/html/data-import.html)]

    -   Data transformation with dplyr [[Link](https://rstudio.github.io/cheatsheets/html/data-transformation.html)]

------------------------------------------------------------------------

-   dplyr: A Grammar of Data Manipulation [[Link](https://CRAN.R-project.org/package=dplyr)]

    -   Two-table verbs [[Link](https://cran.r-project.org/web/packages/dplyr/vignettes/two-table.html)]

-   Model Summary

    -   r-statistics.co by Selva Prabhakaran:

        -   <http://r-statistics.co/Linear-Regression.html>

    -   Meaning Behind Each Section of Summary()

        -   <https://www.learnbymarketing.com/tutorials/explaining-the-lm-summary-in-r/>

-   swirl: `install.packages("swirl")` `libray(swirl)`, and `swirl()` after `rm(list=ls())`

<!-- -   OECD: <https://rforpoliticalscience.com/2023/05/08/how-to-download-oecd-datasets-in-r/> -->
