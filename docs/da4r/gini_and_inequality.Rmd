---
title: "Gini Index and Inequality"
author: "ID, Last Name, First Name"
date: "2024/01/24"
output:
  html_notebook: default
---

## Short Abstract

> In this note, we study GINI index using WDI and compare with other index. In an OECD report,  'OECD Regions and Cities at a Glance 2022' [Link](https://read.oecd-ilibrary.org/urban-rural-and-regional-development/oecd-regions-and-cities-at-a-glance-2022_14108660-en#page1), S80/S20 ratios are used. We consider a question if  the ratio is related to GINI index.

**Definition S80/S20 ratio**: The total income received by the 20% of people with the highest income in a region divided by the total income received by the 20% of people with the lowest income in the same region.



## Information of data

### Poverty and Inequality

**Distribution of income or consumption**

Gini Index: SI.POV.GINI [[Link](https://data.worldbank.org/indicator/SI.POV.GINI)]

Income share held by lowest 20%: SI.DST.FRST.20 [[Link](https://data.worldbank.org/indicator/SI.DST.FRST.20)]

Income share held by second 20%: SI.DST.02ND.20 [[Link](https://data.worldbank.org/indicator/SI.DST.02ND.20)]

Income share held by third 20%: SI.DST.03RD.20 [[Link](https://data.worldbank.org/indicator/SI.DST.03RD.20)]

Income share held by fourth 20%: SI.DST.04TH.20 [[Link](https://data.worldbank.org/indicator/SI.DST.04TH.20)]

Income share held by highest 20%: SI.DST.05TH.20 [[Link](https://data.worldbank.org/indicator/SI.DST.05TH.20)]

## Setup

Install a package `DescTools` first.

```{r}
library(tidyverse)
library(broom)
library(WDI)
library(DescTools)
```

## Introduction

### What is Gini index?

#### Gini Calculator

```{r}
GINI <- function(x){
  Lc(x)[c(1,2)] |> as.tibble() |> mutate(A = p, .after = 1) |> 
  pivot_longer(-1, names_to = "name", values_to = "value") |>
  ggplot(aes(p, value, fill = name)) + 
    geom_area(position = "identity") +
    annotate("text", x = 0.25, y = 0.75, label = paste("GINI = A/(A+L) = ", round(Gini(x, unbiased = FALSE), digits = 2))) + 
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs(title = "GINI Index", x = "People", y = "Wealth", fill = "")}
```

#### Example 1

```{r}
x <- c(0,1)
GINI(x)
```
#### Example 2

```{r}
y <- c(1,2,3,4,5,6,7,8,9,10)
GINI(y)
```

#### Example 3

```{r}
z <- c(1/12,3/12,6/12,9/12,1)
GINI(z)
```

## Importing Data

```{r eval = FALSE}
df_gini <- WDI(indicator = c(gini = "SI.POV.GINI",
                            `0-20` = "SI.DST.FRST.20",
                            `20-40` = "SI.DST.02ND.20",
                            `40-60` = "SI.DST.03RD.20",
                            `60-80` = "SI.DST.04TH.20",
                            `80-100` = "SI.DST.05TH.20"))
```

```{r eval = FALSE}
write_csv(df_gini, "data/gini.csv")
```

```{r}
df_gini <- read_csv("data/gini.csv")
```
```{r}
REGION <- c("1A", "1W", "4E", "6F", "6N", "6X", "7E", "8S", "A4", "A5", 
"A9", "B1", "B2", "B3", "B4", "B6", "B7", "B8", "C4", "C5", "C6", 
"C7", "C8", "C9", "D2", "D3", "D4", "D5", "D6", "D7", "EU", "F1", 
"F6", "M1", "M2", "N6", "OE", "R6", "S1", "S2", "S3", "S4", "T2", 
"T3", "T4", "T5", "T6", "T7", "V1", "V2", "V3", "V4", "XC", "XD", 
"XE", "XF", "XG", "XH", "XI", "XJ", "XL", "XM", "XN", "XO", "XP", 
"XQ", "XT", "XU", "XY", "Z4", "Z7", "ZB", "ZF", "ZG", "ZH", "ZI", 
"ZJ", "ZQ", "ZT")
```

## Viewing Data

```{r}
df_gini
```

```{r}
df_gini_long <- df_gini |> 
  pivot_longer(`0-20`:`80-100`)
df_gini_long
```

```{r}
df_gini_long |> filter(year == 2022) |> 
  filter(name != "gini") |>  drop_na(value) |>
  ggplot(aes(name, value)) + geom_col() + facet_wrap(~country)
```



## Transforming Data

We add a new column with the value `s80/s20` = `80-100`/`0-20`.

```{r}
df_gini <- df_gini |> mutate(`s80/s20` = `80-100`/`0-20`)
df_gini
```

## Visualization and Analysis

### Number of Data in Each Year

Check the number of data available in year year.

```{r}
df_gini |> drop_na(gini, `0-20`, `80-100`) |> 
  ggplot(aes(year)) + geom_bar()
```

### Correlation of Three Indicators

We calculate the correlations among three indicators, GINI, top 20% and s80/s20 ratio.

1. Correlation using all available values.
2. Correlation using all available values of countries.
3. Correlation using all available values of countries in 2018.

```{r}
df_gini |> drop_na(gini, `0-20`, `80-100`) |> select(gini, `80-100`, `s80/s20`) |>
  cor() |> as.data.frame()
```



```{r}
df_gini |> drop_na(gini, `0-20`, `80-100`) |> 
  filter(!(iso2c %in% REGION)) |> select(gini, `80-100`, `s80/s20`) |>
  cor() |> as.data.frame()
```

```{r}
df_gini |> drop_na(gini, `0-20`, `80-100`) |> filter(year == 2018) |> 
  filter(!(iso2c %in% REGION)) |> select(gini, `80-100`, `s80/s20`) |>
  cor() |> as.data.frame()
```

**Observations:** 

- The correlation between GINI index and the top 20% share of income is very close to 1.
- We chose 2018 as it is the year we have the most available values.
- There are no regional values of these three indices. So the values of the first two coincide.

### Scatter Plots

```{r}
df_gini |> drop_na(gini, `0-20`, `80-100`) |> 
  ggplot(aes(`80-100`, gini)) + geom_point() + 
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE) + 
  labs(title = "Scatter plot of top 20 % vs gini")
```

```{r}
df_gini |> drop_na(gini, `0-20`, `80-100`) |> 
  ggplot(aes(`s80/s20`, gini)) + geom_point() + 
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE) +
  labs(title = "Scatter plot of s80/s20 ratio vs gini")
```

```{r}
df_gini |> drop_na(gini, `0-20`, `80-100`) |> 
  ggplot(aes(`s80/s20`, `80-100`)) + geom_point() + 
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE) +
  labs(title = "Scatter plot of s80/s20 ratio vs top 20 %")
```

## Models

We set three models.

```{r}
model_gini_top20 <- df_gini |> lm(gini ~ `80-100`, data = _)
model_gini_8020 <- df_gini |> lm(gini ~ `s80/s20`, data = _)
model_8020_top20 <- df_gini |> lm(`s80/s20` ~ `80-100`, data = _)
```

### Summary of the model `gini` ~ `top 20%`

```{r}
model_gini_top20 |> summary()
```

### Summary of the model `gini` ~ `s80/s20`

```{r}
model_gini_8020 |> summary()
```

### Summary of the model `s80/s20` ~ `top 20%`

```{r}
model_8020_top20 |> summary()
```

### broom::tidy and broom::glance

```{r}
tidy(model_gini_top20) |> rbind(tidy(model_gini_8020)) |> rbind(tidy(model_8020_top20))
```

```{r}
glance(model_gini_top20) |> rbind(glance(model_gini_8020)) |> rbind(glance(model_8020_top20))
```


## Conclusion

The GINI index and the income share held by highest 20% is strongly correlated. The relation is even stronger than the correlation between the GINI index and the `s80/s20` ratio.


## Calculation Model of Gini Index

```{r}
df_gini_calc <- df_gini |> 
  mutate(`0` = 0, `20` = `0-20`,
         `40` = `0-20` + `20-40`, 
         `60` = `0-20` + `20-40` + `40-60`, 
         `80` = `0-20` + `20-40` + `40-60` + `60-80`, 
         `100` = 100) |>
  select(-c(`0-20`:`60-80`)) 
df_gini_calc %>% drop_na() 
```


```{r}
df_gini_calc_long <- df_gini_calc |>  pivot_longer(`0`:`100`, names_to = "classes", values_to = "cumulative_share") |> mutate(classes = as.numeric(classes))
df_gini_calc_long %>% drop_na() 
```

```{r}
df_gini_f <- df_gini_calc_long |> group_by(country, year) |> 
  drop_na(gini) |>
  reframe(gini, gini_spline = round(100-AUC(classes, cumulative_share, method = "spline")/50, digits = 1), gini_trapezoid = round(100-AUC(classes, cumulative_share)/50, digits = 1), `80-100`, `s80/s20`) |> 
  distinct(country, year, gini, gini_spline, gini_trapezoid, `80-100`, `s80/s20`)
df_gini_f
```

```{r}
df_gini_f |> drop_na(gini, gini_spline, gini_trapezoid, `80-100`, `s80/s20`) |> select(gini, gini_spline, gini_trapezoid, `80-100`, `s80/s20`) |> cor() |> as.data.frame()
```
**Observation:**

- Since gini_spline and gini_trapezoid are calculated using the definition of the gini index, they are strongly correlated, though they are not exactly equal.

## Lorenz Curve

```{r}
df_gini_calc_long |> filter(year == 2022) |> drop_na(gini) |> 
  ggplot() + 
  geom_line(aes(classes, cumulative_share, col = country)) + 
  geom_segment(aes(x = 0, y = 0, xend = 100, yend = 100, col = country), color = 'red') + 
  scale_x_continuous(breaks = seq(0,100,by=20)) + 
  scale_y_continuous(breaks = seq(0,100,by=20)) +
  labs(title = "Lorenz Curves of Seven Countries with Data in 2022", col = "countries")
```
