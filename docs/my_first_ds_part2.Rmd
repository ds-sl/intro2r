---
title: "はじめてのデータ・サイエンス, Part II "
author: "ID Your Name"
date: "Last Updated: `r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    toc_float: yes
    highlight: tango
    theme: cerulean
    number_sections: yes
---
# はじめに

```{r}
Sys.setenv(LANG = "en")
library(tidyverse)
library(WDI)
```

```{r eval=FALSE}
dir.create("./data")
```

```
df_gdp <- WDI(country = "all", 
              indicator = c(gdp = "NY.GDP.MKTP.CD"), 
              extra = TRUE)
```

# World Bank: WDI

世界銀行（World Bank）の WDI を使いました。どのようなものか確認しておきましょう。

## 世界銀行（[World Bank](https://www.worldbank.org/en/home)）

* [世界銀行オープンデータ](https://data.worldbank.org)
* [データカタログ](https://datacatalog.worldbank.org/home)
* [世界開発指標（WDI）](https://datatopics.worldbank.org/world-development-indicators/)

世界開発指標は、世界銀行が提供している、オープンデータの一つで、他にも、たくさんのデータを提供しています。また、オープンデータについて、世界銀行は、厳密な定義をしています。

### オープンデータの定義（[Open Data Defined](http://opendatatoolkit.worldbank.org/en/essentials.html)）

オープンデータという言葉は、厳密な意味を持っています。データまたはコンテンツは、出所が明示されオープンという性質が維持されれば、誰でも自由に利用、再利用、再配布できるものを言います。

1. データは法的にオープンでなければなりません。つまり、パブリックドメインに置かれ、最小限の制限で自由に使用できなければなりません。

2. データは技術的にオープンでなければなりません。つまり、誰でも自由に使える一般的なソフトウェアツールを使ってデータにアクセスし、機械で読み取ることが可読な電子フォーマットで提供されていなければならなりません。パスワードやファイアウォールによる制限を受けずに、公共のサーバーで、だれでもアクセスできなければなりません。また、オープンデータを見つけやすくするために、さまざまな組織がオープンデータカタログを作成し管理してく必要があります。

<center><font size="3">データはだれのものでしょうか?  パブリックデータのパブリックとは？</font></center>

## 世界開発指標（WDI）

* [World Development Indicators (WDI)](https://datatopics.worldbank.org/world-development-indicators/) : 世界銀行が開発に関する各国間比較可能なデータの集大成である1400の時系列指標（the World Bank’s premier compilation of cross-country comparable data on development; 1400 time series indicators）
  - テーマ別（Themes）: 貧困と格差、人間、環境、経済、国家と市場、グローバルリンク集（Poverty and Inequality, People, Environment, Economy, States and Markets, Global Links）
  - オープンデータとデータバンク（Open Data & DataBank）: Explore data, Query database
  - Bulk Download: Excel, CSV
  - API Documentation
  
### 世界のさまざまな課題

https://datatopics.worldbank.org/world-development-indicators/

1. 貧困と不平等（Poverty and Inequality）：貧困、繁栄、消費、所得分配
2. 人々（People）：人口動態、教育、労働、健康、ジェンダー
3. 環境（Environment）：農業、気候変動、エネルギー、生物多様性、水、衛生
4. 経済（Economy）：成長、経済構造、所得と貯蓄、貿易、労働生産性
5. 国家と市場（States and Markets）：ビジネス、株式市場、軍事、通信、輸送、テクノロジー
6. グローバルリンク（Global Links）：債務、貿易、援助への依存、難民、観光、移住

### ダッシュボード・データの取得・データコード

さまざまな国際機関では、データを、Excel 形式や、CSV (Comma Separated Values）形式などで、提供する以外に、ダッシュボード形式で、グラフを生成するなどして、データを視覚化をある程度できるようにしています。さらに、コンピュータのアプリケーションでデータを直接取得できるように、API (Application Program Interface) を提供しています。

世界開発指標（WDI）は、これらを、すべて統一した形で提供しているために、非常に使いやすいデータベースになっています。また、上にリストしているように、1400余のさまざまなデータを提供しているために、最初に調べてみることをお勧めするデータベースです。

分析を考えると、Excel や、CSV でダウンロードして、それから、データを読み込むよりも、R で直接データを取得する方が、便利ですので、このコースでは、その方法を、説明しています。

データを探すことも、R の中ですることが可能ですが、データベースに慣れるためにも、WDI のホームページから、トピックを選択して、データを探し、説明も調べて、取得したいデータ・コードを調べることも非常に有効です。

いろいろなトピックに、どのような指標があるか調べて、興味のある、データ・コードをリストしてください。データの名前も同時に、記録しておくと良いでしょう。


## 世界銀行以外の国際機関のパブリックデータ

世界銀行以外にも、それぞれの機関がデータを提供しています。どれも、少しずつ使いやすくなってきています。少しずつ、いくつかのデータベースに、アクセスして、できれば、API の利用の仕方も、習得して、データを調べることに少しずつ慣れていっていただければと思います。

下のリストは、私が個人的に、何度か使ったことのある、データベースです。他にも、たくさんのデータベースがありますので、ぜひ、調べてみてください。

* 国際連合　[UNdata](https://data.un.org)
* 経済協力開発機構　[OECD data](https://data.oecd.org)、
* 世界格差データベース（World Inequality Database）[WID](https://wid.world)、
* 欧州連合の統計局　[Eurostat](https://ec.europa.eu/eurostat)、
* データで見る私たちの世界　[Our World in Data](https://ourworldindata.org)

なども、同様の、ダッシュボードを備えており、データの提供もしている。

<p>
日本では、

* [e-Stat](https://www.e-stat.go.jp/)、
* [ダッシュボード](https://dashboard.e-stat.go.jp)

## 持続的開発目標（SDGs） データ

* 世界銀行：https://databank.worldbank.org/source/sustainable-development-goals-(sdgs)
* 国連：https://unstats.un.org/sdgs/dataportal/database
* データで見る私たちの世界：Our World in Data SGD Tracker: https://sdg-tracker.org/
* SDG Index: https://dashboards.sdgindex.org/map

## 課題

世界開発指標（WDI）の、データで、調べてみたい データコードをいくつか見つけて、書き出してください。


# R の パッケージ WDI の活用

`WDI` パッケージで、データをダウンロードしたり、探したり、詳細情報を得たりできます。

検索や、ダウンロード方法が理解できるように、例示してありますが、ざっと確認して、3.3 のテンプレートを利用すると、グラフを描くこともできます。

## 指標 WDI 検索

WDI のホームページで、データコードを調べることができますが、R の WDI のパッケージにも、`WDIsearch()` という関数があり、これを利用して、検索することが可能です。

`string` に、検索語を入れ、`field` には、name または、indicator とします。すると、indicator と、name を調べられます。

RStudio の右下の窓の、Help に、WDIsearch と入れると、使い方を示してくれます。

下の Code でも　WDIsearch の Help を開いてくれます。

```{r eval=FALSE}
?WDIsearch
```

下にいくつか例を挙げてみましょう。

### 検索例 1（WDI名）

```{r cache=TRUE}
WDIsearch(string = "gdp", field = "name", short = TRUE, cache = NULL)
```

```{r}
WDIsearch(string = "military expenditure", field = "name", short = TRUE, cache = NULL)
```

### 検索例 2（WDI）

```{r cache=TRUE}
WDIsearch(string = "NY.GDP.MKTP.CD", field = "indicator", short = TRUE, cache = NULL)
```
  
### 練習 2. - 検索（short）

名前で検索（"" の間に、（なるべく簡単な）検索文字列を入れてください。）

```{r cache=TRUE, eval=FALSE}
WDIsearch(string = "", field = "name", short = TRUE, cache = NULL)
```

Indicator で検索（"" の間に、調べたい indicator を入れてください。）

```{r cache=TRUE}
WDIsearch(string = "", field = "indicator", short = TRUE, cache = NULL)
```

### 詳しい情報を得るには

`short = FALSE` とします。時間がかかるので、検索は、Indicator と、名前などの情報をもったファイルを手元に持っておくことにします。

```{r cache=TRUE, eval=FALSE}
wdi_cache <- WDIcache()
```
```{r echo=FALSE, eval=FALSE}
write_rds(wdi_cache, "./data/wdi_cache.RData")
```
```{r echo=FALSE}
wdi_cache <- read_rds("./data/wdi_cache.RData")
```


右上の窓枠（pane）から、`wdi_cache` を探して、中身を見てみましょう。series と、country の二つのデータ・フレームからなっているリストです。三角印や、右から二番目の巻物のようなアイコンをクリックすると中身が見えます。

```{r}
WDIsearch(string = "CPI Price", field = "name", short = FALSE, cache = NULL)
```

でも、下の、検索と同じ結果を得ますが、`cache = wdi_cache` を使うと、ダウンロードする情報を減らすことができるということです。

short = FALSE では、データの概要 (description) も得ることができます。
  
### 検索例 3（WDI名）

```{r}
WDIsearch(string = "CPI Price", field = "name", short = FALSE, cache = wdi_cache)
```

- CPTOTNSXN: CPI Price, nominal
  - The consumer price index reflects the change in prices for the average consumer of a constant basket of consumer goods. Data is not seasonally adjusted.

### 検索例 4（WDI）

```{r}
WDIsearch(string = "NY.GDP.MKTP.KD.ZG", field = "indicator", short = FALSE, cache = wdi_cache)
```

  
### 練習 2 - 検索（long w/ cache）

`string` と、`field` を、ふたつとも入れてください。

```{r eval=FALSE}
WDIsearch(string = "", field = "", short = FALSE, cache = wdi_cache)
```

## 指標 WDI データのダウンロード

Indicator が決まったら、ダウンロードします。

右下の、Help Tab に WDI と入れると、使い方もわかります。

```{r eval=FALSE}
?WDI
```
  
### ダウンロード例 1-1

```{r cache=TRUE}
df_gdp1 <- WDI(country = "all", indicator = "NY.GDP.MKTP.CD")
df_gdp1 %>% head()
```

  
### ダウンロード例 1-2

```{r cache=TRUE}
df_gdp2 <- WDI(country = "all", indicator = c(gdp = "NY.GDP.MKTP.CD"))
df_gdp2 %>% head()
```

  
### ダウンロード例 1-3

```{r cache=TRUE}
df_gdp3 <- WDI(country = "all", indicator = c(gdp = "NY.GDP.MKTP.CD"), extra=TRUE, cache=wdi_cache)
df_gdp3 %>% head()
```

  
### ダウンロード例 1-4

```{r cache=TRUE}
df_gdp4 <- WDI(country = c("CN","GB","JP","IN","US","DE"), indicator = c(gdp = "NY.GDP.MKTP.CD"), extra=TRUE, cache=wdi_cache)
df_gdp4 %>% head()
```

#### ダウンロード例 2-1

* NY.GDP.DEFL.KD.ZG: Inflation, GDP deflator (annual %)
* CPTOTNSXN: CPI Price, nominal

```{r cache=TRUE}
df_gdp21 <- WDI(country = "all", 
                indicator = c(gdp_deflator = "NY.GDP.DEFL.KD.ZG", 
                              cpi_price = "CPTOTNSXN"), 
                extra=TRUE, cache=wdi_cache)
df_gdp21 %>% head()
```

```{r}
str(df_gdp21)
```

```{r}
summary(df_gdp21)
```

右上の窓枠の、Environment も見てみましょう。


## 可視化 Visualization

グラフ（Chart）を描いて視覚化しよう

### グラフ 1

```{r}
df_gdp4 %>% ggplot(aes(year, gdp, col=country)) + geom_line()
```

### グラフ 2

```{r}
df_gdp4 %>% drop_na(gdp) %>% 
  ggplot(aes(year, gdp, col=country)) + geom_line() +
  labs(title = paste("WDI - NY.GDP.MKTP.CD: ", "gdp"))
```

### テンプレート Templates

#### 一つの国についての、一つの指標（WDI）と、その略称から、折線グラフを作成

Line Plot with one indicator with abbreviation and one country

```{r cache=TRUE}
chosen_indicator <- "SL.UEM.TOTL.NE.ZS"
short_name <- "unemployment"
chosen_country <- "United States"
WDI(country = "all", indicator = c(short_name = chosen_indicator), extra=TRUE, cache=wdi_cache) %>%
  filter(country == chosen_country) %>% 
  ggplot(aes(year, short_name)) + geom_line() +
  labs(title = paste("WDI ", chosen_indicator, ": ", short_name, " - ", chosen_country),
       y = short_name)
```

#### 一つの国についての、一つの指標（WDI）から、折線グラフを作成

Line Plot with one indicator and one country

```{r cache=TRUE}
chosen_indicator <- "SL.UEM.TOTL.NE.ZS"
chosen_country <- "United States"
WDI(country = "all", indicator = c(chosen_indicator = chosen_indicator), 
    extra=TRUE, cache=wdi_cache) %>%
  filter(country == chosen_country) %>% 
  ggplot(aes(year, chosen_indicator)) + geom_line() +
  labs(title = paste("WDI ", chosen_indicator, " - ", chosen_country), 
       y = chosen_indicator)
```

#### いくつかの国についての、一つの指標（WDI）と、その略称から、折線グラフを作成

Line Plot with one indicator with abbreviation and several countries

```{r cache=TRUE}
chosen_indicator <- "SL.UEM.TOTL.NE.ZS"
short_name <- "unemployment"
chosen_countries <- c("United States","United Kingdom", "Japan")
WDI(country = "all", indicator = c(short_name = chosen_indicator), extra=TRUE, cache=wdi_cache) %>% drop_na(short_name) %>% 
  filter(country %in% chosen_countries) %>% 
  ggplot(aes(year, short_name, col = country)) + geom_line() +
  labs(title = paste("WDI ", chosen_indicator, ": ", short_name), y = short_name)
```


#### 一つの国についての、二つの指標（WDI）と、その略称から、折線グラフを作成

Line Plot with two indicators with abbreviation and one country

```{r cache=TRUE}
chosen_indicator_1 <- "NY.GDP.DEFL.KD.ZG"
short_name_1 <- "gdp_deflator"
chosen_indicator_2 <- "CPTOTSAXNZGY"
short_name_2 <- "cpi_price"
chosen_country <- "United States"
WDI(country = "all", indicator = c(short_name_1 = chosen_indicator_1, short_name_2 = chosen_indicator_2), extra=TRUE, cache=wdi_cache) %>% 
  filter(country == chosen_country) %>% 
  pivot_longer(c(short_name_1, short_name_2), names_to = "class", values_to = "value") %>% drop_na(value) %>%
  ggplot(aes(year, value, col = class)) + geom_line() +
  labs(title = paste("WDI ", chosen_indicator_1, ": ", short_name_1, "\n", chosen_indicator_2, ": ", short_name_2, " - ", chosen_country)) +
  scale_color_manual(labels = c(short_name_1, short_name_2), values = scales::hue_pal()(2))
```

```{r cache=TRUE}
chosen_indicator_1 <- "SL.TLF.CACT.MA.NE.ZS"
short_name_1 <- "male"
chosen_indicator_2 <- "SL.TLF.CACT.FE.NE.ZS"
short_name_2 <- "female"
chosen_country <- "United States"
WDI(country = "all", indicator = c(short_name_1 = chosen_indicator_1, short_name_2 = chosen_indicator_2), extra=TRUE, cache=wdi_cache) %>% 
  filter(country == chosen_country) %>% 
  pivot_longer(c(short_name_1, short_name_2), names_to = "class", values_to = "value") %>% drop_na(value) %>%
  ggplot(aes(year, value, col = class)) + geom_line() +
  labs(title = paste("WDI ", chosen_indicator_1, ": ", short_name_1, "\n", chosen_indicator_2, ": ", short_name_2, " - ", chosen_country)) +
  scale_color_manual(labels = c(short_name_1, short_name_2), values = scales::hue_pal()(2))
```

#### いくつかの国についての、二つの指標（WDI）と、その略称から、折線グラフを作成

Line Plot with two indicators with abbreviation and several countries

```{r cache=TRUE}
chosen_indicator_1 <- "NY.GDP.DEFL.KD.ZG"
short_name_1 <- "gdp_deflator"
chosen_indicator_2 <- "CPTOTSAXNZGY"
short_name_2 <- "cpi_price"
chosen_countries <- c("United States", "France", "Japan")
WDI(country = "all", indicator = c(short_name_1 = chosen_indicator_1, short_name_2 = chosen_indicator_2), extra=TRUE, cache=wdi_cache) %>% 
  filter(country %in% chosen_countries) %>% 
  pivot_longer(c(short_name_1, short_name_2), names_to = "class", values_to = "value") %>% drop_na(value) %>%
  ggplot(aes(year, value, linetype = class, col = country)) + geom_line() +
  labs(title = paste("WDI ", chosen_indicator_1, ": ", short_name_1, "\n", chosen_indicator_2, ": ", short_name_2)) +
  scale_linetype_manual(labels = c(short_name_1, short_name_2), values = c("solid", "dashed"))
```


```{r cache=TRUE}
chosen_indicator_1 <- "SL.TLF.CACT.MA.NE.ZS"
short_name_1 <- "male"
chosen_indicator_2 <- "SL.TLF.CACT.FE.NE.ZS"
short_name_2 <- "female"
chosen_countries <- c("United States", "France", "Japan")
WDI(country = "all", indicator = c(short_name_1 = chosen_indicator_1, short_name_2 = chosen_indicator_2), extra=TRUE, cache=wdi_cache) %>% 
  filter(country %in% chosen_countries) %>% 
  pivot_longer(c(short_name_1, short_name_2), names_to = "class", values_to = "value") %>% drop_na(value) %>%
  ggplot(aes(year, value, linetype = class, col = country)) + geom_line() +
  labs(title = paste("WDI ", chosen_indicator_1, ": ", short_name_1, "\n", chosen_indicator_2, ": ", short_name_2)) +
  scale_linetype_manual(labels = c(short_name_1, short_name_2), values = c("solid", "dashed"))
```


## 練習

上のテンプレートをコピーして、下に貼り付け、指標 `indicator` と、略称 `short_name` と、いくつかの国名 `chosen_countries` を、入れ替えて、試してみてください。

<!-- ### 学生が選択した世界開発指標（WDI）の例 -->

<!-- 19人の受講生に、興味のある指標を選んで、テンプレートを使って、可視化をしてみてください、と課題に出した時に、調べてくれたものです。 -->

<!-- ```{r} -->
<!-- url_indicators <- "https://ds-sl.github.io/intro2r/data/indicators.csv" -->
<!-- df_indicators <- read_csv(url_indicators) %>% left_join(wdi_cache$series) -->
<!-- write_csv(df_indicators, "./data/indicators.csv") -->
<!-- df_indicators %>% distinct(indicator, name) %>% arrange(indicator) -->
<!-- ``` -->

自分で課題を考え、データを選べることは、とても大切だということだと思います。


## プロジェクト

他の WDI のデータで、はじめにの部分と、同様のことをしてみましょう。

1. 最初に、`gdp = "NY.GDP.MKTP.CD"` としましたが、GNI per capita, Atlas method (current US$): NY.GNP.PCAP.CD に変えてみましょう。

```{r cache=TRUE, eval=FALSE}
df_gnppcap <- WDI(country = "all", 
              indicator = c(gnppcap = "NY.GNP.PCAP.CD"), 
              extra = TRUE)
```

2. [World Development Indicators](https://datatopics.worldbank.org/world-development-indicators/) のサイトの下にある、Data Themes（テーマ）から自分が調べたいテーマを選び、そのテーマから、データコードを取得して、同様の分析をしてみてください。データがあまりない場合もありますので、ある程度データが多いものを選択することをお勧めします。

3. 可能なら、3 の内容も含めて、選択した、WDI について、調べてみましょう。

# 参考 - 今後の学習のために

## RNotebook の活用

下のリンクを開き、右上の Code ボタンから、Download Rmd を選択すると、ダウンロードできますから、ダインロードしたものを、プロジェクト・フォールダーに移動またはコピーしてください。ダウンロードできないときは、Ctrl を押しながら、Download Rmd をクリックすると、Save As で保存できると思います。ブラウザーによって仕様が異なりますから、適切な方法を選んでください。

-   <https://ds-sl.github.io/intro2r/RNotebook-J.nb.html>
-   <https://ds-sl.github.io/intro2r/Rmarkdown-J.nb.html>

Windows でも、Mac でも提供されている、Google Chrome の場合には、Code ボタンから、ダンロードされるはずです。

-  参照：データサイエンスを始めましょう：[RMarkdown](https://icu-hsuzuki.github.io/ds4aj/rmarkdown.html#rmarkdown)

-  参考書：[R Markdown クックブック](https://gedevan-aleksizde.github.io/rmarkdown-cookbook/)


## 参考文献 References

-   R For Data Science, by H. Wickham: <https://r4ds.had.co.nz>

    -   Introduction: <https://r4ds.had.co.nz/explore-intro.html#explore-intro>

-   Bookdown: <https://bookdown.org>, [Archive](https://bookdown.org/home/archive/)

-   [Get Started: R Studio で R をはじめよう、R Markdown](https://ds-sl.github.io/intro2r/getstarted.html)

-   [Introducton to R](https://ds-sl.github.io/intro2r/intro2r.nb.html#3_Data_Analysis_Using_RStudio)

-   [Rではじめるデータ・サイエンス](https://ds-sl.github.io/intro2r/intro2rj.nb.html)

-   [Data Analysis for Researchers 2022](https://icu-hsuzuki.github.io/da4r2022/)

-   [データ・サイエンスを始めましょう - Data Science for All](https://icu-hsuzuki.github.io/ds4aj/)

## 練習問題 Posit Primers

Posit Primers <https://posit.cloud/learn/primers>

### 最初の演習 {-}

-   [Visualization Basics](https://rstudio.cloud/learn/primers/1.1)
-   [Programming Basics](https://rstudio.cloud/learn/primers/1.2)


## R w/ Chat GPT

- RTutor: https://rtutor.ai
  - アカウントを作成せずに、ChatGPT を使った、R プログラミングを体験できます。
  - すでに読み込んである、データと、テンプレートが、あり日本語のテンプレートもあります。ChatGPT にコード作成を依頼するときは、英語の方が良いようです。
  - 手元の、PC  からデータを読み込んで試すことも可能です。

Chat GPT などの、AI の利用に興味がある方は、この[リンク](https://icu-hsuzuki.github.io/ds_education/chatgpt.html)を参照してください。

### 例

WDI の データ `df_gdp.csv` を読み込む。

1. Use ggplot2 to create a line graph of gdp of Japan over years

2. Use ggplot2 to create a histogram of the distribution of gdp of year 2021 with 30 bins.
  - Delete binwidth = 0.1
  - Use log10 scale

3. Use ggplot2 to create a boxplot of gdp vs. region of year 2021. Color by region. 
  - Use log10 scale.
  - Swap x and y.
  - Delete legend
  
4. First create a world map and add a column of iso2c using maps::iso.alpha of region. Next create an object map_gdp by joining the world map and our data df without region column by iso2c = iso2c. Finally create a world map with fill color by income
  - Delete scale_fill_gradient