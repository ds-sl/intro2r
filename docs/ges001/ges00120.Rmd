---
title: "GES 001 演習7"
author: "H. Suzuki"
date: "2024年2月6日"
output:
  html_notebook: default
  html_document:
    df_print: paged
  ioslides_presentation:
    widescreen: true
    df_print: paged
---


## 準備

1.  （自分のPCまたは教室のPCに）ログイン

2.  ウェッブ・ブラウザー（Google Chrome など）を起動

    -   Moodle の GES001 経済と経済学のサイトから、このスライドのページを表示（リンク「Rでデータサイエンス」[**https://ds-sl.github.io/intro2r/ges001/**](https://ds-sl.github.io/intro2r/ges001/)）

3.  （別のタブまたは ウィンドウで）PositCloud にログイン[[Posit.cloud](https://posit.cloud/)]

    -   アカウントのない人はサイン・アップ [[共有プロジェクト](https://posit.cloud/content/5539763)] から、Save a Permanent Copy）

    -   RStudio を自分のコンピュータにインストールしている人は起動

4.  リンクの右上の Raw ボタンの右の Copy a raw file からコピーして演習用 R Markdown ファイルを作成（あとで再度解説します）[[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/ges001/w6eda.Rmd)]

## ファイル

### ファイルを作成するときの注意

1.  Posit Cloud のときは、まず、Login し、intro2rj のプロジェクトに入り、 ファイルから、ges001 のフォルダーを選択して、移動します。この中に、data フォルダが作成されていることを確認し、このges001 に、新しく作成したファイルを保存します。新しく作成したファイルの入っているフォルダーの中に、data フォルダがあることが大切です。そこに、データを書き込みます。

2.  RStudio の場合には、まずは、あたらしい　Project を作成します。File \> New Project から作成します。すでに、作成してある場合は、それを、Open Project や、Recent Project から開きます。その中に、新しいファイルを作成します。作成したフォルダーに、data フォルダがあることを確認してください。新しく作成したファイルの入っているフォルダーの中に、data フォルダがあることが大切です。そこに、データを書き込みます。

------------------------------------------------------------------------

### ファイルを提出するときの注意

RStudio の場合には、自分の PC に作成したファイルがありますから、問題ないと思いますが、Posit Cloud で作成した場合には、提出したいファイルの左にあるチェックボックスをチェックします。Files の 右端にある、ギアマークの Export を押すと、ダウンロードできます。それを提出してください。末尾が、nb.html となっているものを提出していただくのがよいですが、よくわからないときは、nb.html ファイルと、Rmd ファイルと両方提出してください、

### 課題1について

- 課題1：解説 [リンク](https://ds-sl.github.io/intro2r/ges001/w5a_response.nb.html)
- 課題1：解答例 [リンク](https://ds-sl.github.io/intro2r/ges001/w5eda0.nb.html)

## 第7週

02/01(TH) 　気候変動に対する対策

　　　　　　 気候変動と貧困の連鎖

第7週は、南部アフリカや南アジアなど気候変動から大きな影響を受けている国々の現状を取り上げます。

02/06 (TU)　Rでデータサイエンス7：都市部と農村部の生活状況の格差　 [[Main](https://ds-sl.github.io/intro2r/ges001/ges001-main.nb.html)]・[授業]

Urban and rural development

Access to electricity, urban (% of urban population)：EG.ELC.ACCS.UR.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.ACCS.UR.ZS)]

Access to electricity, rural (% of rural population)：EG.ELC.ACCS.RU.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.ACCS.RU.ZS)]

People using at least basic drinking water services, urban (% of urban population)：SH.H2O.BASW.UR.ZS [[Link](https://data.worldbank.org/indicator/SH.H2O.BASW.ZS)]

People using at least basic sanitation services, rural (% of rural population)：SH.STA.BASS.RU.ZS [[Link](https://data.worldbank.org/indicator/SH.STA.BASS.RU.ZS)]

People using at least basic sanitation services, urban (% of urban population)：SH.STA.BASS.UR.ZS [[Link](https://data.worldbank.org/indicator/SH.STA.BASS.UR.ZS)]

People using at least basic drinking water services, rural (% of rural population)：SH.H2O.BASW.RU.ZS [[Link](https://data.worldbank.org/indicator/SH.H2O.BASW.RU.ZS)]

## 探索的データ分析（EDA）ワークフロー

-   表題 Title
-   概要 Abstract
-   データ情報：データ名、データコード、変数名、データ概要
-   データの取得 - ダウンロードして保存しておく
    -   準備：`library(tidyverse); library(WDI)`
    -   `df_w6eda <- WDI(indicator = c(co2pcap = "EN.ATM.CO2E.PC",
                              forest = "AG.LND.FRST.ZS"), extra = TRUE)` 
      - *二つ以上の指標、それぞれに変数名* `co2pcap`, `forest`
      - 追加情報：`extra = TRUE`; `region` 地域情報, `income` 収入レベル
    -   データの確認：データが十分あるか、国名リスト、地域名リスト
-   分析する国のリスト：南部アフリカ関税同盟、国や地域を選択

------------------------------------------------------------------------

### 探索的データ分析（Exploratory Data Analysis）ワークフロー（続き）

-   分析・視覚化
    -   各年毎のデータの数の棒グラフ
    -   経年変化
        -   日本（身近な馴染みのあるデータを確認）
        -   南部アフリカ関税同盟、選択した国・地域
    -   分布
        -   ヒストグラム（年を指定した度数分布）
        -   値が大きい10カ国とその値の棒グラフ
        -   値が小さい10カ国とその値の棒グラフ
    -   相関
        -   散布図（scatter plot）x-軸と、y-軸に、それぞれの変数をとる
        -   相関係数
-   各項目に、気づいたこと、疑問などを記録

# 演習 2月6日（火）

## 内容

### データ情報

-   Access to electricity, urban (% of urban population)：EG.ELC.ACCS.UR.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.ACCS.UR.ZS)]

-   Access to electricity, rural (% of rural population)：EG.ELC.ACCS.RU.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.ACCS.RU.ZS)]

-   People using at least basic drinking water services, urban (% of urban population)：SH.H2O.BASW.UR.ZS [[Link](https://data.worldbank.org/indicator/SH.H2O.BASW.ZS)]

-   People using at least basic drinking water services, rural (% of rural population)：SH.H2O.BASW.RU.ZS [[Link](https://data.worldbank.org/indicator/SH.H2O.BASW.RU.ZS)]

-   People using at least basic sanitation services, urban (% of urban population)：SH.STA.BASS.UR.ZS [[Link](https://data.worldbank.org/indicator/SH.STA.BASS.UR.ZS)]

-   People using at least basic sanitation services, rural (% of rural population)：SH.STA.BASS.RU.ZS [[Link](https://data.worldbank.org/indicator/SH.STA.BASS.RU.ZS)]

------------------------------------------------------------------------

### データの取得

#### 準備

```{r}
library(tidyverse)
library(WDI)
```

------------------------------------------------------------------------

```{r eval = FALSE}
df_service <- WDI(
  indicator = c(electricity_urban = "EG.ELC.ACCS.UR.ZS",
                electricity_rural = "EG.ELC.ACCS.RU.ZS",
                water_urban = "SH.H2O.BASW.UR.ZS",
                water_rural = "SH.H2O.BASW.RU.ZS",
                sanitation_urban = "SH.STA.BASS.UR.ZS",
                sanitation_rural = "SH.STA.BASS.RU.ZS"
                ), extra = TRUE)
```

```{r eval=FALSE}
write_csv(df_service, "data/service.csv")
```

```{r}
df_service <- read_csv("data/service.csv")
```

------------------------------------------------------------------------

### データの確認

```{r}
df_service
```

```{r}
str(df_service)
```

------------------------------------------------------------------------

### 変形

#### 変数の選択（selecting）

```{r}
df_serv <- df_service |> 
  select(country, iso2c, year, electricity_urban:sanitation_rural, region, income)
df_serv
```

---

### 縦長の表（Long Table）に変換 

*`electricity_urban` の列から `sanitation_rural` の列までを、変数を name に、値を value に入れて、縦に並べます。

```{r}
df_serv_long <- df_serv |> 
  pivot_longer(electricity_urban:sanitation_rural)
df_serv_long
```

---

### 各年毎のデータの数の確認

```{r}
df_serv_long |> drop_na(value) |> 
  ggplot(aes(year)) + geom_bar()
```

---

#### 各指標ごとに積み上げ棒グラフにしてみます

`fill` を `col` に変えるとどうなるでしょうか。

```{r}
df_serv_long |> drop_na(value) |> 
  ggplot(aes(year, fill = name)) + geom_bar()
```

**気づいたこと、疑問**

------------------------------------------------------------------------

### 国と地域
#### 地域の `iso2c` コード

country には、国と地域両方が入っています。地域の iso2c は以下のものです。

```{r}
REGION <- c("1A", "1W", "4E", "6F", "6N", "6X", "7E", "8S", "A4", "A5", 
"A9", "B1", "B2", "B3", "B4", "B6", "B7", "B8", "C4", "C5", "C6", 
"C7", "C8", "C9", "D2", "D3", "D4", "D5", "D6", "D7", "EU", "F1", 
"F6", "M1", "M2", "N6", "OE", "R6", "S1", "S2", "S3", "S4", "T2", 
"T3", "T4", "T5", "T6", "T7", "V1", "V2", "V3", "V4", "XC", "XD", 
"XE", "XF", "XG", "XH", "XI", "XJ", "XL", "XM", "XN", "XO", "XP", 
"XQ", "XT", "XU", "XY", "Z4", "Z7", "ZB", "ZF", "ZG", "ZH", "ZI", 
"ZJ", "ZQ", "ZT")
```

---

#### 地域のリストを表示

```{r eval=FALSE}
df_serv |> filter(iso2c %in% REGION) |> distinct(country, iso2c)
```

---

#### 国名とその地域・所得レベルを表示

```{r eval=FALSE}
df_serv |> filter(!(iso2c %in% REGION)) |> distinct(country, iso2c,region,income)
```

------------------------------------------------------------------------

### 国や地域の選択

```{r}
ASEAN <- c("BN", "KH", "ID", "LA", "MY", "MM", "PH", "SG", "VN")
```

```{r}
BRICS <- c("Brazil", "Russian Federation", "India", "China", "South Africa")
```

```{r}
SACU <- c("South Africa", "Namibia", "Eswatini", "Botswana", "Lesotho")
```

```{r}
CHOSEN_COUNTRIES <- c("Suriname", "Belize", "Brazil", "Colombia")
```

---

### 変数同士の相関関係: NA ではないところのみ選択

```{r}
df_serv |> filter(!(iso2c %in% REGION)) |> # 地域以外（国のみ選択）
  drop_na(electricity_urban:sanitation_rural) |> 
  select(electricity_urban:sanitation_rural) |> cor()
```

値の正負：正の相関・負の相関、1に近いと強い正の相関、-1に近いと強い負の相関

相関係数：散布図の近似（回帰）直線の傾きが正なら正、負なら負、直線に近い程、1 または-1 に近い

---

### 経年変化

### a. 日本

```{r}
df_serv_long |> filter(country == "Japan") |> drop_na(value) |>
  ggplot(aes(year, value, col = name)) + geom_line()
```

---

```{r}
df_serv_long |> filter(country == "Japan") |> drop_na(value)
```

```{r}
df_serv_long |> filter(iso2c %in% ASEAN) |> drop_na(value) |>
  ggplot(aes(year, value, col = country, linetype = name)) + geom_line()
```

---

```{r}
df_serv_long |> filter(iso2c %in% ASEAN) |> drop_na(value) |> 
  filter(value < 80) |>
  ggplot(aes(year, value, col = country, linetype = name)) + geom_line()
```

---

```{r}
df_serv_long |> filter(country %in% SACU) |> drop_na(value) |>
  ggplot(aes(year, value, col = country, linetype = name)) + geom_line()
```

### 箱ひげ図（Boxplot）

```{r}
df_serv_long |> filter(name == "electricity_rural") |> 
  filter(region != "Aggregates") |> drop_na(value) |>
  ggplot(aes(region, value)) + geom_boxplot() + coord_flip()
```

---

```{r}
df_serv |> filter(region != "Aggregates") |> drop_na(electricity_rural) |>
  ggplot(aes(region, electricity_rural)) + geom_boxplot() + coord_flip()
```

```{r}
df_serv_long |> filter(name %in% c("electricity_rural", "electricity_urban")) |> 
  filter(income != "Aggregates") |> drop_na(value) |>
  ggplot(aes(income, value, fill = name)) + geom_boxplot() + coord_flip()
```

```{r fig.height=7, fig.width=7}
df_serv_long |> filter(income != "Aggregates", income != "Not classified") |> drop_na(value) |>
  ggplot(aes(income, value, fill = name)) + geom_boxplot() + coord_flip()
```


## ファイルリンク

基本的には、PositCloud（<https://posit.cloud/>）を使って実習

-   探索的データ分析（EDA） -
    -   課題2:例 男女別失業率（unemployment.Rmd） [[リンク](https://ds-sl.github.io/intro2r/ges001/unemployment.nb.html)], [[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/ges001/unemployment.Rmd)]
    -   課題2：テンプレート：w7eda_template.Rmd [[リンク](https://ds-sl.github.io/intro2r/ges001/w7eda_template.nb.html)], [[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/ges001/w7eda_template.Rmd)]

**2023.2.10.23:59** までに Moodle の課題２提出ボックスに提出してください。

できたグラフだけでも構いませんから、期限までに提出してください。解説を加え、課題２再提出ボックスを作成する予定です。


## 課題2

以下の指標の中から、二つ以上（複数）を選択して、データの概要（description）を記録し、データを WDI で取得し、以下の分析をする。

1.  各年毎のデータの数の棒グラフ
2.  経年変化を表す折れ線グラフ
    a.  日本、またはデータがある国
    b.  選択したいくつかの国
3.  複数の指標の値を一列に含む縦長の表（Long Table）を作成し 　
    a. 日本、またはデータがある国の、複数の指標を色分けした経年変化のグラフ 　
    b. 選択したいくつかの国についての経年変化のグラフを、国を色分けし、指標は線の種類を変えたグラフ
4.  二つのデータの散布図- NA は取り除くこと。（log10 スケールを用いる場合は値が正のもののみに限定）
    a.  （地域を除き）国のみの散布図 （近似（回帰）直線を表示）
    b.  最近の年の（地域を除き）国のみの散布図　（近似（回帰）直線を表示）
    c.  b に対応する相関係数
5.  カテゴリー変数（Categorical Variable: region, income, year など）と、数値変数（Numberical Variable）一組についての箱ヒゲ図（Boxplot）

それぞれについて考察（気づいたこと、疑問など）を記す

**2023.2.10.23:59** までに Moodle の課題２提出ボックスに提出してください。

------------------------------------------------------------------------

### 確認作業

-   Preview で確認。

-   Web Browser で、w5_c123456.nb.html など、R Notebook を見て確認。

-   もし、問題があれば、Run ボタンの右の三角から、Run All を選択し、エラーがでないか確認。

-   最初にもどる。

------------------------------------------------------------------------

### 途中でのエラー

-   入力したときには、例を参照して、スペルなどを確認してください。全角になっていると問題がおきます。() がペアでマッチしているか、確認してください。
-   引用符が入っていなかったり、== のところが、= だったり、いろいろな可能性があります。Error message を読むこともたいせつです。エラーがでた、Code Chunk と、Error message を、ChatGPT や、Google Bard, Google Search に入れると、解決方法を教えてくれることもあります。
-   File not found の、エラーがでたときには、上から順に、Run （Code Chunk の右上の三角印を押して実行）してみてください。または、エラーが出たところに、カーソルを置き、上の、Run ボタンの右の三角から、Run All Chunks Above を選択すると、そこまでのすべての　Code Chunk を実行してくれます。
-   上の方法でうまくいかないときは、data フォルダに、データ（\*\*\*.csv）が入っているかを確認、なければ、data フォルダがあることを確認して、最初のデータ読み込みのところを実行してみてください。
-   実行できていても、結果が見えないこともあります。そのときは、Code Chunk の下にある、山二つの記号を押してみてください。これは、結果を表示、非表示にします。それが原因で隠れている場合があります。


## 参考文献


- 課題1：解説 [リンク](https://ds-sl.github.io/intro2r/ges001/w5a_response.nb.html)
- 課題1：解答例 [リンク](https://ds-sl.github.io/intro2r/ges001/w5eda0.nb.html)

1.  「みんなのデータサイエンス - Data Science for All」[[はじめてのデータサイエンス](https://icu-hsuzuki.github.io/ds4aj/first-example.html#first-example)]

    -   導入として、GDP（国内総生産）のデータを使って説明しています。

2.  Posit Recipes（旧 Posit Primers）: The Basics 対話型の演習サイトの最初 [[Link](https://posit.cloud/learn/recipes)]

3.  Posit Cheat Sheet. 早見表です。印刷して使うために、PDF も提供しています。[[Site Link](https://rstudio.github.io/cheatsheets/)]

4.  DataCamp Cheat Sheet: Tidyverse for Biginners. データサイエンスの教育をしている会社の早見表の一つです。基本が簡単にまとまっています。[[Link](https://images.datacamp.com/image/upload/v1676302697/Marketing/Blog/Tidyverse_Cheat_Sheet.pdf)]

5. 箱ひげ図の見方 [Link](https://bellcurve.jp/statistics/course/5220.html)、外れ値検出のある箱ひげ図 [Link](https://bellcurve.jp/statistics/course/5222.html)

6. Video: [Histogram](https://vimeo.com/221607341), [Boxplot](https://vimeo.com/222358034)
