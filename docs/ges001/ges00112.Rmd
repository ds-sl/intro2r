---
title: "GES 001 演習6"
author: "H. Suzuki"
date: "2024年1月31日"
output:
  ioslides_presentation:
    widescreen: true
    df_print: paged
  html_document:
    df_print: paged
  html_notebook: default
---

## 準備

1.  （自分のPCまたは教室のPCに）ログイン

2.  ウェッブ・ブラウザー（Google Chrome など）を起動

    -   Moodle の GES001 経済と経済学のサイトから、このスライドのページを表示（リンク「Rでデータサイエンス」[**https://ds-sl.github.io/intro2r/ges001/**](https://ds-sl.github.io/intro2r/ges001/)）

3.  （別のタブまたは ウィンドウで）PositCloud にログイン[[Posit.cloud](https://posit.cloud/)]

    -   アカウントのない人はサイン・アップ [[共有プロジェクト](https://posit.cloud/content/5539763)] から、Save a Permanent Copy）

    -   RStudio を自分のコンピュータにインストールしている人は起動

4.  リンクの右上の Raw ボタンの右の Copy a raw file からコピーして演習用 R Markdown ファイルを作成（あとで再度解説します）[[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/ges001/w5eda.Rmd)]

## ファイル

### ファイルを作成するときの注意

1.  Posit Cloud のときは、まず、Login し、intro2rj のプロジェクトに入り、 ファイルから、ges001 のフォルダーを選択して、それを選択して、移動します。この中に、data フォルダが作成されていることを確認し、このges001 に、新しく作成したファイルを保存します。新しく作成したファイルの入っているフォルダーの中に、data フォルダがあることが大切です。そこに、データを書き込みます。

2.  RStudio の場合には、まずは、あたらしい　Project を作成します。File \> New Project から作成します。すでに、作成してある場合は、それを、Open Project や、Recent Project から開きます。その中に、新しいファイルを作成します。作成したフォルダーに、data フォルダがあることを確認してください。新しく作成したファイルの入っているフォルダーの中に、data フォルダがあることが大切です。そこに、データを書き込みます。

------------------------------------------------------------------------

### ファイルを提出するときの注意

RStudio の場合には、自分の PC に作成したファイルがありますから、問題ないと思いますが、Posit Cloud で作成した場合には、提出したいファイルの左にあるチェックボックスをチェックします。Files の 右端にある、ギアマークの Export を押すと、ダウンロードできます。それを提出してください。末尾が、nb.html となっているものを提出していただくのがよいですが、よくわからないときは、nb.html ファイルと、Rmd ファイルと両方提出してください、

## 第6週

01/25(TH)　気候変動問題の原因：気候変動と経済活動1

　　　　　　気候変動問題の原因：気候変動と経済活2

第6週、第7週の講義では、気候変動が我々の生活にもたらす影響と対策を議論します。

基本的にIPCCの第6次評価報告書（<https://www.data.jma.go.jp/cpdinfo/ipcc/index.html> ）

をテキストに使っています。

01/30(TU)　Rでデータサイエンス6：気候変動　 [[Main](https://ds-sl.github.io/intro2r/ges001/ges001-main.nb.html)]・[授業]

Environment-Climate　

CO2 emissions (metric tons per capita) ：EN.ATM.CO2E.PC [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)]

Forest area (% of land area)：AG.LND.FRST.ZS [[Link](https://data.worldbank.org/indicator/AG.LND.FRST.ZS)]

Renewable electricity output (% of total electricity output)：EG.ELC.RNEW.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.RNEW.ZS)]

Electricity production from oil, gas and coal sources (% of total)：EG.ELC.FOSL.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.FOSL.ZS)]

Electricity production from nuclear sources (% of total)：EG.ELC.NUCL.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.NUCL.ZS)]

IEA:　Energy Statistics Data Browser　データ元

<https://www.iea.org/data-and-statistics/data-tools/energy-statistics-data-browser?country=WORLD&fuel=Energy%20supply&indicator=ElecGenByFuel>

## 探索的データ分析（EDA）ワークフロー

-   表題 Title
-   概要 Abstract
-   データ情報：データ名、データコード、変数名、データ概要
-   データの取得 - ダウンロードして保存しておく
    -   準備：`library(tidyverse); library(WDI)`
    -   `WDI(indicator(ed_exp = "SE.XPD.TOTL.GD.ZS"))` *一つの指標*
    -   データの確認：データが十分あるか、国名リスト、地域名リスト
-   分析する国のリスト：南部アフリカ関税同盟、国や地域を選択

------------------------------------------------------------------------

### 探索的データ分析（Exploratory Data Analysis）ワークフロー（続き）

-   分析・視覚化
    -   各年毎のデータの数の棒グラフ
    -   経年変化
        -   日本（身近な馴染みのあるデータを確認）
        -   南部アフリカ関税同盟、選択した国・地域
    -   分布
        -   ヒストグラム（年を指定した度数分布）
        -   値が大きい10カ国とその値の棒グラフ
        -   値が小さい10カ国とその値の棒グラフ
-   各項目に、気づいたこと、疑問などを記録

# 演習 1月31日（火）

## 内容

### データ情報

-   CO2 emissions (metric tons per capita) ：EN.ATM.CO2E.PC [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)]

-   Forest area (% of land area)：AG.LND.FRST.ZS [[Link](https://data.worldbank.org/indicator/AG.LND.FRST.ZS)]

-   Renewable electricity output (% of total electricity output)：EG.ELC.RNEW.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.RNEW.ZS)]

-   Electricity production from oil, gas and coal sources (% of total)：EG.ELC.FOSL.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.FOSL.ZS)]

-   Electricity production from nuclear sources (% of total)：EG.ELC.NUCL.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.NUCL.ZS)]

------------------------------------------------------------------------

### データの取得

#### 準備

```{r}
library(tidyverse)
library(WDI)
```

------------------------------------------------------------------------

#### データのダウンロードと保存

```{r eval = FALSE}
df_environment <- WDI(
  indicator = c(co2pcap = "EN.ATM.CO2E.PC",
                forest = "AG.LND.FRST.ZS",
                renewable = "EG.ELC.RNEW.ZS",
                fossil = "EG.ELC.FOSL.ZS",
                nuclea = "EG.ELC.NUCL.ZS"
                ), extra = TRUE)
```

------------------------------------------------------------------------

*２回目からは、`data` から読み込めるようにしておく* **ファイル (Rmd) の保存場所に data フォルダがあることを確認**

```{r eval = FALSE}
write_csv(df_environment, "data/environment.csv")
```

```{r}
df_environment <- read_csv("data/environment.csv")
```

------------------------------------------------------------------------

### データの確認

```{r}
df_environment
```

------------------------------------------------------------------------

#### 地域の `iso2c` コード

country には、国と地域両方が入っています。地域の iso2c は以下のものです。

```{r}
REGION <- c("1A", "1W", "4E", "7E", "8S", "B8", "EU", "F1", "OE", "S1", 
"S2", "S3", "S4", "T2", "T3", "T4", "T5", "T6", "T7", "V1", "V2", 
"V3", "V4", "XC", "XD", "XE", "XF", "XG", "XH", "XI", "XJ", "XL", 
"XM", "XN", "XO", "XP", "XQ", "XT", "XU", "XY", "Z4", "Z7", "ZF", 
"ZG", "ZH", "ZI", "ZJ", "ZQ", "ZT")
```

地域のリストを表示

```{r eval=FALSE}
df_environment |> filter(iso2c %in% REGION) |> distinct(country, iso2c)
```

国名とその地域・所得レベルを表示

```{r eval=FALSE}
df_environment |> filter(!(iso2c %in% REGION)) |> distinct(country, iso2c,region,income)
```

------------------------------------------------------------------------

#### 変数の選択（selecting）

```{r}
df_env <- df_environment |> 
  select(country, iso2c, year, co2pcap, forest, 
         renewable, fossil, nuclea, region, income)
df_env
```

------------------------------------------------------------------------

### 変数同士の相関関係: NA ではないところのみ選択

```{r}
df_env |> filter(!(iso2c %in% REGION)) |> # 地域以外（国のみ選択）
  drop_na(co2pcap, forest, renewable, fossil, nuclea) |> 
  select(co2pcap, forest, renewable, fossil, nuclea) |> cor()
```

値の正負：正の相関・負の相関、1に近いと強い正の相関、-1に近いと強い負の相関

相関係数：散布図の近似（回帰）直線の傾きが正なら正、負なら負、直線に近い程、1 または-1 に近い

## ファイルリンク

基本的には、PositCloud（<https://posit.cloud/>）を使って実習

-   探索的データ分析（EDA） -
    -   練習と一つ目の課題（w6eda.Rmd） [[リンク](https://ds-sl.github.io/intro2r/ges001/w6eda.nb.html)], [[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/ges001/w6eda.Rmd)]
    -   二つ目以降の課題：w6eda1.Rmd [[リンク](https://ds-sl.github.io/intro2r/ges001/w6eda1.nb.html)], [[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/ges001/w6eda1.Rmd)]
-   課題：**2023.1.27. 23:59** までに Moodle の演習の課題ボックスに提出したものについては、なるべく、早く見て、フィードバックを書きます。それ以降に提出されたものも見ますが、フィードバックは遅くなると思ってください。

R Notebook のソースファイル（Rmd）を取得方法

-   **Rmd のリンクをクリックし Raw の横の Copy a raw file からコピー、新規 RMarkdown ファイルを PositCloud または RStudio のプロジェクト内に作成しペースト**

## 演習

以下の指標の中から、二つを選択して、データの概要（description）を記録し、データを WDI で取得し、以下の分析をする。

1.  各年毎のデータの数の棒グラフ
2.  国または地域を選択
3.  それぞれの経年変化を表す折れ線グラフ
    a.  日本
    b.  選択した国または地域
4.  二つのデータの散布図-必要に応じて log10 スケールを用いる
    a.  すべての値の散布図
    b.  NA ではない値の散布図、近似（回帰）直線を表示
    c.  地域を除き国のみの散布図、近似（回帰）直線を表示
    d.  最近の年を選択し、地域を除き国のもの散布図、近似（回帰）直線を表示

それぞれについて考察（気づいたこと、疑問など）を記す

<!-- **2023.2.3.23:59** までに Moodle の演習の課題ボックスに提出したものについては、なるべく、早く見て、フィードバックを書きます。それ以降に提出されたものも見ますが、フィードバックは遅くなると思ってください。 -->

------------------------------------------------------------------------

### 確認作業

-   Preview で確認。

-   Web Browser で、w5_c123456.nb.html など、R Notebook を見て確認。

-   もし、問題があれば、Run ボタンの右の三角から、Run All を選択し、エラーがでないか確認。

-   最初にもどる。

------------------------------------------------------------------------

### 途中でのエラー

-   入力したときには、例を参照して、スペルなどを確認してください。全角になっていると問題がおきます。() がペアでマッチしているか、確認してください。
-   引用符が入っていなかったり、== のところが、= だったり、いろいろな可能性があります。Error message を読むこともたいせつです。エラーがでた、Code Chunk と、Error message を、ChatGPT や、Google Bard, Google Search に入れると、解決方法を教えてくれることもあります。
-   File not found の、エラーがでたときには、上から順に、Run （Code Chunk の右上の三角印を押して実行）してみてください。または、エラーが出たところに、カーソルを置き、上の、Run ボタンの右の三角から、Run All Chunks Above を選択すると、そこまでのすべての　Code Chunk を実行してくれます。
-   上の方法でうまくいかないときは、data フォルダに、データ（\*\*\*.csv）が入っているかを確認、なければ、data フォルダがあることを確認して、最初のデータ読み込みのところを実行してみてください。
-   実行できていても、結果が見えないこともあります。そのときは、Code Chunk の下にある、山二つの記号を押してみてください。これは、結果を表示、非表示にします。それが原因で隠れている場合があります。

------------------------------------------------------------------------

## データ

### データ情報

-   データ１：一人当たりの二酸化炭素排出量 (CO2 emissions (metric tons per capita))、"EN.ATM.CO2E.PC"、co2pcap [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)]

-   概要：Carbon dioxide emissions are those stemming from the burning of fossil fuels and the manufacture of cement. They include carbon dioxide produced during consumption of solid, liquid, and gas fuels and gas flaring.

-   データ２：森林面積（％）(Forest area (% of land area))、"AG.LND.FRST.ZS"、forest [[Link](https://data.worldbank.org/indicator/AG.LND.FRST.ZS)]

-   概要：Forest area is land under natural or planted stands of trees of at least 5 meters in situ, whether productive or not, and excludes tree stands in agricultural production systems (for example, in fruit plantations and agroforestry systems) and trees in urban parks and gardens.

------------------------------------------------------------------------

### データの取得

#### 準備

```{r}
library(tidyverse)
library(WDI)
```

データのダウンロードと保存：コードと変数名を指定。

```{r eval = FALSE}
df_w6eda <- WDI(indicator = c(co2pcap = "EN.ATM.CO2E.PC",
                              forest = "AG.LND.FRST.ZS"),
                extra = TRUE)
```

*２回目からは、data から読み込めるようにしておく ファイル (Rmd) の保存場所に data フォルダがあることを確認*

```{r eval = FALSE}
write_csv(df_w6eda, "data/w6eda.csv")
```

```{r}
df_w6eda <- read_csv("data/w6eda.csv")
```

------------------------------------------------------------------------

### データの確認

```{r}
df_w6eda
```

```{r}
str(df_w6eda)
```

------------------------------------------------------------------------

#### 変数の選択（selecting）

```{r}
df_w6 <- df_w6eda |> 
  select(country, iso2c, year, co2pcap, forest, region, income)
df_w6
```

------------------------------------------------------------------------

### 各年毎のデータの数の棒グラフ

```{r}
df_w6eda |> drop_na(co2pcap, forest) |>
  ggplot(aes(year)) + geom_bar()
```

------------------------------------------------------------------------

### 国と地域

country には、国と地域両方が入っています。地域の iso2c は以下のものです。

```{r}
REGION <- c("1A", "1W", "4E", "7E", "8S", "B8", "EU", "F1", "OE", "S1", 
"S2", "S3", "S4", "T2", "T3", "T4", "T5", "T6", "T7", "V1", "V2", 
"V3", "V4", "XC", "XD", "XE", "XF", "XG", "XH", "XI", "XJ", "XL", 
"XM", "XN", "XO", "XP", "XQ", "XT", "XU", "XY", "Z4", "Z7", "ZF", 
"ZG", "ZH", "ZI", "ZJ", "ZQ", "ZT")
```

------------------------------------------------------------------------

#### 地域のリストを表示

```{r}
df_w6eda |> filter(iso2c %in% REGION) |> distinct(country, iso2c)
```

------------------------------------------------------------------------

#### 国名とその地域・所得レベルを表示

```{r}
df_w6eda |> filter(!(iso2c %in% REGION)) |> distinct(country, iso2c, region, income)
```

------------------------------------------------------------------------

### 分析する国のリスト

BRICS を選択することにます。

```{r}
BRICS <- c("Brazil", "Russian Federation", "India", "China", "South Africa")
```

------------------------------------------------------------------------

### 経年変化

### a. 日本

```{r}
df_w6 |> drop_na(co2pcap) |> filter(country == "Japan") |>
  ggplot(aes(year, co2pcap)) + geom_line() + 
  labs(title = "日本の一人当たりの二酸化炭素排出量")
```

------------------------------------------------------------------------

```{r}
df_w6 |> drop_na(forest) |> filter(country == "Japan") |>
  ggplot(aes(year, forest)) + geom_line() + 
  labs(title = "日本の森林面積（％）")
```

### b. 選択した国・地域

```{r}
df_w6 |> drop_na(co2pcap) |> filter(country %in% BRICS) |>
  ggplot(aes(year, co2pcap, col = country)) + geom_line() + 
  labs(title = "BRICS の一人当たりの二酸化炭素排出量")
```

------------------------------------------------------------------------

```{r}
df_w6 |> drop_na(forest) |> filter(country %in% BRICS) |>
  ggplot(aes(year, forest, col = country)) + geom_line() + 
  labs(title = "BRICSの森林面積（％）")
```

------------------------------------------------------------------------

### 二つのデータの散布図

必要に応じて log10 スケール

#### a. すべての値の散布図

```{r}
df_w6 |> ggplot(aes(forest, co2pcap, col = region)) + geom_point()
```

------------------------------------------------------------------------

#### b. NA ではない値の散布図、近似（回帰）直線を表示

```{r}
df_w6 |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

------------------------------------------------------------------------

#### c. 地域を除き国のみの散布図、近似（回帰）直線を表示

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

------------------------------------------------------------------------

#### d. 最近の年を選択し、地域を除き国のもの散布図、近似（回帰）直線を表示

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

---

**気づいたこと・疑問**

-   森林面積が10％ よりも少ない国が多い

-   弱い負の相関があるようだ

-   授業で求めた相関係数は、-0.1832374。これは、四つの指標すべての値があり（NA ではなく）国地域も分けず、すべての年のデータでの相関をとったもの。傾向はある程度わかる。

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  select(co2pcap, forest) |> cor() 
```

---

### 参考

```{r eval = FALSE}
df_w6 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  select(co2pcap, forest) |> lm(co2pcap ~ forest, data = _) |> summary()
```

-  Residuals: 直線よりどのぐらい大き値や小さい値があるか
-  Coefficients: Estimate の　(Intercept) は直線の y-切片、forest は、傾き
-  Residual Standard Error: 直線からこの値の幅の間に、おおよそ 2/3 程度（68.2%）の点が入っている
-  Multiple R-squared: 直線がどの程度近似しているか、0 と 1 の間で、相関係数の二乗
-  p-value: かなり小さいと（たとえば 0.01 未満）相関が正か負かがほぼ確実といえる

---

```{r eval = TRUE, echo = FALSE}
df_w6 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  select(co2pcap, forest) |> lm(co2pcap ~ forest, data = _) |> summary()
```


------------------------------------------------------------------------

### 演習の内容と課題

基本的には、PositCloud（<https://posit.cloud/>）を使って実習

-   探索的データ分析（EDA） -
    -   練習と一つ目の課題（w6eda.Rmd） [[リンク](https://ds-sl.github.io/intro2r/ges001/w5eda.nb.html)], [[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/ges001/w5eda.Rmd)]
    -   二つ目以降の課題：w6eda1.Rmd [[リンク](https://ds-sl.github.io/intro2r/ges001/w5eda1.nb.html)], [[Rmd](https://github.com/ds-sl/intro2r/blob/main/docs/ges001/w5eda1.Rmd)]

<!-- -   課題：2023.2.3.23:59 までに Moodle の演習の課題ボックスに提出したものについては、なるべく、早く見て、フィードバックを書きます。それ以降に提出されたものも見ますが、フィードバックは遅くなると思ってください。 -->

## 参考文献

1.  「みんなのデータサイエンス - Data Science for All」[[はじめてのデータサイエンス](https://icu-hsuzuki.github.io/ds4aj/first-example.html#first-example)]

    -   導入として、GDP（国内総生産）のデータを使って説明しています。

2.  Posit Recipes（旧 Posit Primers）: The Basics 対話型の演習サイトの最初 [[Link](https://posit.cloud/learn/recipes)]

3.  Posit Cheat Sheet. 早見表です。印刷して使うために、PDF も提供しています。[[Site Link](https://rstudio.github.io/cheatsheets/)]

4.  DataCamp Cheat Sheet: Tidyverse for Biginners. データサイエンスの教育をしている会社の早見表の一つです。基本が簡単にまとまっています。[[Link](https://images.datacamp.com/image/upload/v1676302697/Marketing/Blog/Tidyverse_Cheat_Sheet.pdf)]
