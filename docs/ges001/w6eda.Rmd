---
title: "第6週 探索的データ分析 - EDA, Part I"
author: "ID, Last, First"
date: "2024年1月30日"
output:
  html_notebook: default
---

## 演習

以下の指標の中から、二つを選択して、データの概要（description）を記録し、データを WDI で取得し、以下の分析をする。

1.  各年毎のデータの数の棒グラフ
2.  国または地域を選択
3.  それぞれの経年変化を表す折れ線グラフ
    a.  日本
    b.  選択した国または地域
4.  二つのデータの散布図-必要に応じて log10 スケールを用いる
    a.  すべての値の散布図
    b.  NA ではない値の散布図、近似（回帰）直線を表示
    c.  地域を除き国のみの散布図、近似（回帰）直線を表示
    d.  最近の年を選択し、地域を除き国のもの散布図、近似（回帰）直線を表示

それぞれについて考察（気づいたこと、疑問など）を記す

<!-- **2023.2.3.23:59** までに Moodle の演習の課題ボックスに提出したものについては、なるべく、早く見て、フィードバックを書きます。それ以降に提出されたものも見ますが、フィードバックは遅くなると思ってください。 -->



### データ情報

-   CO2 emissions (metric tons per capita) ：EN.ATM.CO2E.PC [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)]

-   Forest area (% of land area)：AG.LND.FRST.ZS [[Link](https://data.worldbank.org/indicator/AG.LND.FRST.ZS)]

-   Renewable electricity output (% of total electricity output)：EG.ELC.RNEW.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.RNEW.ZS)]

-   Electricity production from oil, gas and coal sources (% of total)：EG.ELC.FOSL.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.FOSL.ZS)]

-   Electricity production from nuclear sources (% of total)：EG.ELC.NUCL.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.NUCL.ZS)]


### 確認作業

-   Preview で確認。

-   Web Browser で、w5_c123456.nb.html など、R Notebook を見て確認。

-   もし、問題があれば、Run ボタンの右の三角から、Run All を選択し、エラーがでないか確認。

-   最初にもどる。



### 途中でのエラー

-   入力したときには、例を参照して、スペルなどを確認してください。全角になっていると問題がおきます。() がペアでマッチしているか、確認してください。
-   引用符が入っていなかったり、== のところが、= だったり、いろいろな可能性があります。Error message を読むこともたいせつです。エラーがでた、Code Chunk と、Error message を、ChatGPT や、Google Bard, Google Search に入れると、解決方法を教えてくれることもあります。
-   File not found の、エラーがでたときには、上から順に、Run （Code Chunk の右上の三角印を押して実行）してみてください。または、エラーが出たところに、カーソルを置き、上の、Run ボタンの右の三角から、Run All Chunks Above を選択すると、そこまでのすべての　Code Chunk を実行してくれます。
-   上の方法でうまくいかないときは、data フォルダに、データ（\*\*\*.csv）が入っているかを確認、なければ、data フォルダがあることを確認して、最初のデータ読み込みのところを実行してみてください。
-   実行できていても、結果が見えないこともあります。そのときは、Code Chunk の下にある、山二つの記号を押してみてください。これは、結果を表示、非表示にします。それが原因で隠れている場合があります。


# 例：二酸化炭素排出量と森林面積

## データ

### データ情報

-   データ１：一人当たりの二酸化炭素排出量 (CO2 emissions (metric tons per capita))、"EN.ATM.CO2E.PC"、co2pcap [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)]

-   概要：Carbon dioxide emissions are those stemming from the burning of fossil fuels and the manufacture of cement. They include carbon dioxide produced during consumption of solid, liquid, and gas fuels and gas flaring.

-   データ２：森林面積（％）(Forest area (% of land area))、"AG.LND.FRST.ZS"、forest [[Link](https://data.worldbank.org/indicator/AG.LND.FRST.ZS)]

-   概要：Forest area is land under natural or planted stands of trees of at least 5 meters in situ, whether productive or not, and excludes tree stands in agricultural production systems (for example, in fruit plantations and agroforestry systems) and trees in urban parks and gardens.



### データの取得

#### 準備

```{r}
library(tidyverse)
library(WDI)
```

データのダウンロードと保存：コードと変数名を指定。

```{r eval = FALSE}
df_w6eda <- WDI(indicator = c(co2pcap = "EN.ATM.CO2E.PC",
                              forest = "AG.LND.FRST.ZS"),
                extra = TRUE)
```

*２回目からは、data から読み込めるようにしておく ファイル (Rmd) の保存場所に data フォルダがあることを確認*

```{r eval = FALSE}
write_csv(df_w6eda, "data/w6eda.csv")
```

```{r}
df_w6eda <- read_csv("data/w6eda.csv")
```



### データの確認

```{r}
df_w6eda
```

```{r}
str(df_w6eda)
```



#### 変数の選択（selecting）

```{r}
df_w6 <- df_w6eda |> 
  select(country, iso2c, year, co2pcap, forest, region, income)
df_w6
```



### 各年毎のデータの数の棒グラフ

```{r}
df_w6eda |> drop_na(co2pcap, forest) |>
  ggplot(aes(year)) + geom_bar()
```



### 国と地域

country には、国と地域両方が入っています。地域の iso2c は以下のものです。

```{r}
REGION <- c("1A", "1W", "4E", "6F", "6N", "6X", "7E", "8S", "A4", "A5", 
"A9", "B1", "B2", "B3", "B4", "B6", "B7", "B8", "C4", "C5", "C6", 
"C7", "C8", "C9", "D2", "D3", "D4", "D5", "D6", "D7", "EU", "F1", 
"F6", "M1", "M2", "N6", "OE", "R6", "S1", "S2", "S3", "S4", "T2", 
"T3", "T4", "T5", "T6", "T7", "V1", "V2", "V3", "V4", "XC", "XD", 
"XE", "XF", "XG", "XH", "XI", "XJ", "XL", "XM", "XN", "XO", "XP", 
"XQ", "XT", "XU", "XY", "Z4", "Z7", "ZB", "ZF", "ZG", "ZH", "ZI", 
"ZJ", "ZQ", "ZT")
```



#### 地域のリストを表示

```{r}
df_w6eda |> filter(iso2c %in% REGION) |> distinct(country, iso2c)
```



#### 国名とその地域・所得レベルを表示

```{r}
df_w6eda |> filter(!(iso2c %in% REGION)) |> distinct(country, iso2c, region, income)
```



### 分析する国のリスト

BRICS を選択します。

```{r}
BRICS <- c("Brazil", "Russian Federation", "India", "China", "South Africa")
```



### 経年変化

### a. 日本

```{r}
df_w6 |> drop_na(co2pcap) |> filter(country == "Japan") |>
  ggplot(aes(year, co2pcap)) + geom_line() + 
  labs(title = "日本の一人当たりの二酸化炭素排出量")
```



```{r}
df_w6 |> drop_na(forest) |> filter(country == "Japan") |>
  ggplot(aes(year, forest)) + geom_line() + 
  labs(title = "日本の森林面積（％）")
```

### b. 選択した国・地域

```{r}
df_w6 |> drop_na(co2pcap) |> filter(country %in% BRICS) |>
  ggplot(aes(year, co2pcap, col = country)) + geom_line() + 
  labs(title = "BRICS の一人当たりの二酸化炭素排出量")
```



```{r}
df_w6 |> drop_na(forest) |> filter(country %in% BRICS) |>
  ggplot(aes(year, forest, col = country)) + geom_line() + 
  labs(title = "BRICSの森林面積（％）")
```



### 二つのデータの散布図

必要に応じて log10 スケール

#### a. すべての値の散布図

```{r}
df_w6 |> ggplot(aes(forest, co2pcap, col = region)) + geom_point()
```



#### b. NA ではない値の散布図、近似（回帰）直線を表示

```{r}
df_w6 |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```



#### c. 地域を除き国のみの散布図、近似（回帰）直線を表示

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```



#### d. 最近の年を選択し、地域を除き国のもの散布図、近似（回帰）直線を表示

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

**気づいたこと・疑問**

-   森林面積が10％ よりも少ない国が多い

-   弱い負の相関があるようだ

-   授業で求めた相関係数は、-0.1832374。これは、四つの指標すべての値があり（NA ではなく）国地域も分けず、すべての年のデータでの相関をとったもの。傾向はある程度わかる。

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  select(co2pcap, forest) |> cor() 
```


# 実習

# 例：二酸化炭素排出量と[選択した指標]

## データ

### データ情報

-   データ１：一人当たりの二酸化炭素排出量 (CO2 emissions (metric tons per capita))、"EN.ATM.CO2E.PC"、co2pcap [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)]

-   概要：Carbon dioxide emissions are those stemming from the burning of fossil fuels and the manufacture of cement. They include carbon dioxide produced during consumption of solid, liquid, and gas fuels and gas flaring.

-   データ２：名前、コード、変数名、リンク

-   概要：



### データの取得

#### 準備

```{r}
library(tidyverse)
library(WDI)
```

データのダウンロードと保存：コードと変数名を指定。

```{r eval = FALSE}
df_w6eda_1 <- WDI(indicator = c(co2pcap = "EN.ATM.CO2E.PC",
                              forest = "AG.LND.FRST.ZS"),
                extra = TRUE)
```

*２回目からは、data から読み込めるようにしておく ファイル (Rmd) の保存場所に data フォルダがあることを確認*

```{r eval = FALSE}
write_csv(df_w6eda_1, "data/w6eda_1.csv")
```

```{r}
df_w6eda_1 <- read_csv("data/w6eda_1.csv")
```



### データの確認

```{r}
df_w6eda_1
```

```{r}
str(df_w6eda_1)
```



#### 変数の選択（selecting）

```{r}
df_w6_1 <- df_w6eda_1 |> 
  select(country, iso2c, year, co2pcap, forest, region, income)
df_w6_1
```



### 各年毎のデータの数の棒グラフ

```{r}
df_w6eda_1 |> drop_na(co2pcap, forest) |>
  ggplot(aes(year)) + geom_bar()
```



### 国と地域

country には、国と地域両方が入っています。地域の iso2c は以下のものです。

```{r}
REGION <- c("1A", "1W", "4E", "6F", "6N", "6X", "7E", "8S", "A4", "A5", 
"A9", "B1", "B2", "B3", "B4", "B6", "B7", "B8", "C4", "C5", "C6", 
"C7", "C8", "C9", "D2", "D3", "D4", "D5", "D6", "D7", "EU", "F1", 
"F6", "M1", "M2", "N6", "OE", "R6", "S1", "S2", "S3", "S4", "T2", 
"T3", "T4", "T5", "T6", "T7", "V1", "V2", "V3", "V4", "XC", "XD", 
"XE", "XF", "XG", "XH", "XI", "XJ", "XL", "XM", "XN", "XO", "XP", 
"XQ", "XT", "XU", "XY", "Z4", "Z7", "ZB", "ZF", "ZG", "ZH", "ZI", 
"ZJ", "ZQ", "ZT")
```



#### 地域のリストを表示

```{r}
df_w6eda_1 |> filter(iso2c %in% REGION) |> distinct(country, iso2c)
```



#### 国名とその地域・所得レベルを表示

```{r}
df_w6eda_1 |> filter(!(iso2c %in% REGION)) |> distinct(country, iso2c, region, income)
```



### 分析する国のリスト

BRICS を選択します。

```{r}
BRICS <- c("Brazil", "Russian Federation", "India", "China", "South Africa")
```



### 経年変化

### a. 日本

```{r}
df_w6_1 |> drop_na(co2pcap) |> filter(country == "Japan") |>
  ggplot(aes(year, co2pcap)) + geom_line() + 
  labs(title = "日本の一人当たりの二酸化炭素排出量")
```



```{r}
df_w6_1 |> drop_na(forest) |> filter(country == "Japan") |>
  ggplot(aes(year, forest)) + geom_line() + 
  labs(title = "日本の森林面積（％）")
```

### b. 選択した国・地域

```{r}
df_w6_1 |> drop_na(co2pcap) |> filter(country %in% BRICS) |>
  ggplot(aes(year, co2pcap, col = country)) + geom_line() + 
  labs(title = "BRICS の一人当たりの二酸化炭素排出量")
```



```{r}
df_w6_1 |> drop_na(forest) |> filter(country %in% BRICS) |>
  ggplot(aes(year, forest, col = country)) + geom_line() + 
  labs(title = "BRICSの森林面積（％）")
```



### 二つのデータの散布図

必要に応じて log10 スケール

#### a. すべての値の散布図

```{r}
df_w6_1 |> ggplot(aes(forest, co2pcap, col = region)) + geom_point()
```



#### b. NA ではない値の散布図、近似（回帰）直線を表示

```{r}
df_w6_1 |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```



#### c. 地域を除き国のみの散布図、近似（回帰）直線を表示

```{r}
df_w6_1 |> filter(!(iso2c %in% REGION)) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```



#### d. 最近の年を選択し、地域を除き国のもの散布図、近似（回帰）直線を表示

```{r}
df_w6_1 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

**気づいたこと・疑問**

-   森林面積が10％ よりも少ない国が多い

-   弱い負の相関があるようだ

-   授業で求めた相関係数は、-0.1832374。これは、四つの指標すべての値があり（NA ではなく）国地域も分けず、すべての年のデータでの相関をとったもの。傾向はある程度わかる。

```{r}
df_w6_1 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  select(co2pcap, forest) |> cor() 
```


