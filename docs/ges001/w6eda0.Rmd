---
title: "第6週 探索的データ分析 - EDA"
author: "Hiroshi Suzuki"
date: "2024年1月30日"
output:
  html_notebook: 
    toc: yes
    toc_float: yes
---

## 演習

以下の指標の中から、二つを選択して、データの概要（description）を記録し、データを WDI で取得し、以下の分析をする。

1.  各年毎のデータの数の棒グラフ
2.  国または地域を選択
3.  それぞれの経年変化を表す折れ線グラフ
    a.  日本
    b.  選択した国または地域
4.  二つのデータの散布図-必要に応じて log10 スケールを用いる
    a.  すべての値の散布図
    b.  NA ではない値の散布図、近似（回帰）直線を表示
    c.  地域を除き国のみの散布図、近似（回帰）直線を表示
    d.  最近の年を選択し、地域を除き国のもの散布図、近似（回帰）直線を表示

それぞれについて考察（気づいたこと、疑問など）を記す

<!-- **2023.2.3.23:59** までに Moodle の演習の課題ボックスに提出したものについては、なるべく、早く見て、フィードバックを書きます。それ以降に提出されたものも見ますが、フィードバックは遅くなると思ってください。 -->

**注：以下においては、地域はすべて BRICS とし、4 項目目は、d のみを示し、相関係数の表示も省略。また、データは、一括で読み込む。**

# 環境（Environment）について

## 概要（Abstract）

以下においては、世界銀行の、世界開発指標（World Development Indicators）の、五つの指標、すなわち、一人当たりのCO2排出量（単位：トン）、森林面積（陸地面積に占める割合）、および、総発電量に占める、再生可能エネルギー発電量、化石燃料（石油、ガス、石炭）による発電量、原子力による発電量から、二つずつ指標を選択し、それらの関係について考察する。

## はじめに

### データについて

-   CO2 emissions (metric tons per capita) ：EN.ATM.CO2E.PC [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)] (co2pcap)

    -   Carbon dioxide emissions are those stemming from the burning of fossil fuels and the manufacture of cement. They include carbon dioxide produced during consumption of solid, liquid, and gas fuels and gas flaring.

    -   一人当たりのCO2排出量（単位：トン）：二酸化炭素排出量は、化石燃料の燃焼とセメントの製造に由来するものである。固形燃料、液体燃料、ガス燃料の消費時に発生する二酸化炭素や、ガスのフレアリングも含まれる。

-   Forest area (% of land area)：AG.LND.FRST.ZS [[Link](https://data.worldbank.org/indicator/AG.LND.FRST.ZS)] (forest)

    -   Forest area is land under natural or planted stands of trees of at least 5 meters in situ, whether productive or not, and excludes tree stands in agricultural production systems (for example, in fruit plantations and agroforestry systems) and trees in urban parks and gardens.

    -   森林面積（陸地面積に占める割合）：森林面積とは、生産的か否かを問わず、原位置で5m以上の樹木の天然林または人工林の下にある土地であり、農業生産システム（例えば、果樹園やアグロフォレストリーシステム）における樹木の立木や、都市の公園や庭園の樹木を除く。

-   Renewable electricity output (% of total electricity output)：EG.ELC.RNEW.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.RNEW.ZS)] (renewable)

    -   Renewable electricity is the share of electrity generated by renewable power plants in total electricity generated by all types of plants.

    -   再生可能エネルギー発電量（総発電量に占める割合）：再生可能エネルギー発電量とは、再生可能エネルギー発電所で発電された電力が、すべての種類の発電所で発電された電力に占める割合。

-   Electricity production from oil, gas and coal sources (% of total)：EG.ELC.FOSL.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.FOSL.ZS)] (fossil)

    -   Sources of electricity refer to the inputs used to generate electricity. Oil refers to crude oil and petroleum products. Gas refers to natural gas but excludes natural gas liquids. Coal refers to all coal and brown coal, both primary (including hard coal and lignite-brown coal) and derived fuels (including patent fuel, coke oven coke, gas coke, coke oven gas, and blast furnace gas). Peat is also included in this category.

    -   化石燃料（石油、ガス、石炭）による発電量（総発電量に占める割合）：電力源とは、発電に使用される投入物を指す。石油は原油および石油製品。ガスとは天然ガスを指し、天然ガス液体は含まない。石炭は、一次炭（硬質炭、褐炭を含む）と派生燃料（パテント燃料、コークス炉コークス、ガスコークス、コークス炉ガス、高炉ガスを含む）のすべての石炭と褐炭を指す。泥炭もこのカテゴリーに含まれる。

-   Electricity production from nuclear sources (% of total)：EG.ELC.NUCL.ZS [[Link](https://data.worldbank.org/indicator/EG.ELC.NUCL.ZS)] (nuclear)

    -   Sources of electricity refer to the inputs used to generate electricity. Nuclear power refers to electricity produced by nuclear power plants.

    -   原子力による発電量（総発電量に占める割合）：電力源とは、発電に使用される投入物を指す。原子力発電とは、原子力発電所で生産された電力を指す。

### データの取得

#### 準備

```{r}
library(tidyverse)
library(WDI)
```

データのダウンロードと保存：コードと変数名を指定。

```{r eval = FALSE}
df_environment <- WDI(
  indicator = c(co2pcap = "EN.ATM.CO2E.PC",
                forest = "AG.LND.FRST.ZS",
                renewable = "EG.ELC.RNEW.ZS",
                fossil = "EG.ELC.FOSL.ZS",
                nuclear = "EG.ELC.NUCL.ZS"
                ), extra = TRUE)
```

*２回目からは、data から読み込めるようにしておく ファイル (Rmd) の保存場所に data フォルダがあることを確認*

```{r eval = FALSE}
write_csv(df_environment, "data/environment.csv")
```

```{r}
df_environment <- read_csv("data/environment.csv")
```

### データの確認

```{r}
df_environment
```

```{r}
str(df_environment)
```

#### データの数

すべての指標の値があるもののデータ数を、年毎に表示する。

```{r}
df_env |> drop_na(co2pcap, forest, renewable, fossil, nuclear) |> 
  ggplot(aes(year)) + geom_bar()
```

-   データは、1990年以降で、すべてのデータが存在するのは、2014年ごろとなる。のちに、それぞれの場合に、個別にみる。

#### 参考

それぞれのデータがどのくらいあるか見たい時は、データを縦長（long data）にして使う次のような方法もある。おおよそ、どの指標のデータが少ないかがわかる。

```{r}
df_env |> pivot_longer(cols = c(co2pcap, forest, renewable, fossil, nuclear)) |> 
  drop_na(value) |> ggplot(aes(year, fill = name)) + geom_bar(col = "black", linewidth = 0.1)
```

- すべてのデーが十分あるのは、2014年。ある程度あるのは、2015年、それ以降は、co2pcap と、forest のみ。

#### 変数の選択（selecting）

```{r}
df_env <- df_environment |> 
  select(country, iso2c, year, co2pcap, forest, 
         renewable, fossil, nuclear, region, income)
df_env
```

### 変数の相関関係

データを概観するため、授業の最初に見たように、国を選択し、変数の相関関係を見てみる。

```{r}
df_env |> filter(!(iso2c %in% REGION)) |> # 地域以外（国のみ選択）
  drop_na(co2pcap, forest, renewable, fossil, nuclear) |> 
  select(co2pcap, forest, renewable, fossil, nuclear) |> cor()
```

2014年に限定してみる。

```{r}
df_env |> filter(!(iso2c %in% REGION), year == 2014) |> # 地域以外（国のみ選択）
  drop_na(co2pcap, forest, renewable, fossil, nuclear) |> 
  select(co2pcap, forest, renewable, fossil, nuclear) |> cor()
```




### 国と地域

country には、国と地域両方が入っています。地域の iso2c は以下のものです。

```{r}
REGION <- c("1A", "1W", "4E", "6F", "6N", "6X", "7E", "8S", "A4", "A5", 
"A9", "B1", "B2", "B3", "B4", "B6", "B7", "B8", "C4", "C5", "C6", 
"C7", "C8", "C9", "D2", "D3", "D4", "D5", "D6", "D7", "EU", "F1", 
"F6", "M1", "M2", "N6", "OE", "R6", "S1", "S2", "S3", "S4", "T2", 
"T3", "T4", "T5", "T6", "T7", "V1", "V2", "V3", "V4", "XC", "XD", 
"XE", "XF", "XG", "XH", "XI", "XJ", "XL", "XM", "XN", "XO", "XP", 
"XQ", "XT", "XU", "XY", "Z4", "Z7", "ZB", "ZF", "ZG", "ZH", "ZI", 
"ZJ", "ZQ", "ZT")
```

#### 地域のリストを表示

```{r}
df_env |> filter(iso2c %in% REGION) |> distinct(country, iso2c)
```

#### 国名とその地域・所得レベルを表示

```{r}
df_env |> filter(!(iso2c %in% REGION)) |> distinct(country, iso2c, region, income)
```

### 分析する国のリスト

BRICS と呼ばれる、ブラジル、ロシア、インド、中国、南アフリカ４カ国についてデータをみる。

```{r}
BRICS <- c("Brazil", "Russian Federation", "India", "China", "South Africa")
```

# 二酸化炭素排出量と森林面積

## データ

### データ情報

-   データ１：一人当たりの二酸化炭素排出量 (CO2 emissions (metric tons per capita))、"EN.ATM.CO2E.PC"、co2pcap [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)]

-   概要：二酸化炭素排出量は、化石燃料の燃焼とセメントの製造に由来するものである。固形燃料、液体燃料、ガス燃料の消費時に発生する二酸化炭素や、ガスのフレアリングも含まれる。Carbon dioxide emissions are those stemming from the burning of fossil fuels and the manufacture of cement. They include carbon dioxide produced during consumption of solid, liquid, and gas fuels and gas flaring.

-   データ２：森林面積（％）(Forest area (% of land area))、"AG.LND.FRST.ZS"、forest [[Link](https://data.worldbank.org/indicator/AG.LND.FRST.ZS)]

-   概要：森林面積とは、生産的か否かを問わず、原位置で5m以上の樹木の天然林または人工林の下にある土地であり、農業生産システム（例えば、果樹園やアグロフォレストリーシステム）における樹木の立木や、都市の公園や庭園の樹木を除く。Forest area is land under natural or planted stands of trees of at least 5 meters in situ, whether productive or not, and excludes tree stands in agricultural production systems (for example, in fruit plantations and agroforestry systems) and trees in urban parks and gardens.

### 経年変化

### a. 日本

```{r}
df_w6 |> drop_na(co2pcap) |> filter(country == "Japan") |>
  ggplot(aes(year, co2pcap)) + geom_line() + 
  labs(title = "日本の一人当たりの二酸化炭素排出量")
```

```{r}
df_w6 |> drop_na(forest) |> filter(country == "Japan") |>
  ggplot(aes(year, forest)) + geom_line() + 
  labs(title = "日本の森林面積（％）")
```

### b. 選択した国・地域

```{r}
df_w6 |> drop_na(co2pcap) |> filter(country %in% BRICS) |>
  ggplot(aes(year, co2pcap, col = country)) + geom_line() + 
  labs(title = "BRICS の一人当たりの二酸化炭素排出量")
```

```{r}
df_w6 |> drop_na(forest) |> filter(country %in% BRICS) |>
  ggplot(aes(year, forest, col = country)) + geom_line() + 
  labs(title = "BRICSの森林面積（％）")
```

### 二つのデータの散布図

必要に応じて log10 スケール

#### a. すべての値の散布図

```{r}
df_w6 |> ggplot(aes(forest, co2pcap, col = region)) + geom_point()
```

#### b. NA ではない値の散布図、近似（回帰）直線を表示

```{r}
df_w6 |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

#### c. 地域を除き国のみの散布図、近似（回帰）直線を表示

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

#### d. 最近の年を選択し、地域を除き国のもの散布図、近似（回帰）直線を表示

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

**気づいたこと・疑問**

-   森林面積が10％ よりも少ない国が多い

-   弱い負の相関があるようだ

-   授業で求めた相関係数は、-0.1832374。これは、四つの指標すべての値があり（NA ではなく）国地域も分けず、すべての年のデータでの相関をとったもの。傾向はある程度わかる。

```{r}
df_w6 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  select(co2pcap, forest) |> cor() 
```

# 実習

# 例：二酸化炭素排出量と[選択した指標]

## データ

### データ情報

-   データ１：一人当たりの二酸化炭素排出量 (CO2 emissions (metric tons per capita))、"EN.ATM.CO2E.PC"、co2pcap [[Link](https://data.worldbank.org/indicator/EN.ATM.CO2E.PC)]

-   概要：Carbon dioxide emissions are those stemming from the burning of fossil fuels and the manufacture of cement. They include carbon dioxide produced during consumption of solid, liquid, and gas fuels and gas flaring.

-   データ２：名前、コード、変数名、リンク

-   概要：

### データの取得

#### 準備

```{r}
library(tidyverse)
library(WDI)
```

データのダウンロードと保存：コードと変数名を指定。

```{r eval = FALSE}
df_w6eda_1 <- WDI(indicator = c(co2pcap = "EN.ATM.CO2E.PC",
                              forest = "AG.LND.FRST.ZS"),
                extra = TRUE)
```

*２回目からは、data から読み込めるようにしておく ファイル (Rmd) の保存場所に data フォルダがあることを確認*

```{r eval = FALSE}
write_csv(df_w6eda_1, "data/w6eda_1.csv")
```

```{r}
df_w6eda_1 <- read_csv("data/w6eda_1.csv")
```

### データの確認

```{r}
df_w6eda_1
```

```{r}
str(df_w6eda_1)
```

#### 変数の選択（selecting）

```{r}
df_w6_1 <- df_w6eda_1 |> 
  select(country, iso2c, year, co2pcap, forest, region, income)
df_w6_1
```

### 各年毎のデータの数の棒グラフ

```{r}
df_w6eda_1 |> drop_na(co2pcap, forest) |>
  ggplot(aes(year)) + geom_bar()
```

### 国と地域

country には、国と地域両方が入っています。地域の iso2c は以下のものです。

```{r}
REGION <- c("1A", "1W", "4E", "6F", "6N", "6X", "7E", "8S", "A4", "A5", 
"A9", "B1", "B2", "B3", "B4", "B6", "B7", "B8", "C4", "C5", "C6", 
"C7", "C8", "C9", "D2", "D3", "D4", "D5", "D6", "D7", "EU", "F1", 
"F6", "M1", "M2", "N6", "OE", "R6", "S1", "S2", "S3", "S4", "T2", 
"T3", "T4", "T5", "T6", "T7", "V1", "V2", "V3", "V4", "XC", "XD", 
"XE", "XF", "XG", "XH", "XI", "XJ", "XL", "XM", "XN", "XO", "XP", 
"XQ", "XT", "XU", "XY", "Z4", "Z7", "ZB", "ZF", "ZG", "ZH", "ZI", 
"ZJ", "ZQ", "ZT")
```

#### 地域のリストを表示

```{r}
df_w6eda_1 |> filter(iso2c %in% REGION) |> distinct(country, iso2c)
```

#### 国名とその地域・所得レベルを表示

```{r}
df_w6eda_1 |> filter(!(iso2c %in% REGION)) |> distinct(country, iso2c, region, income)
```

### 分析する国のリスト

BRICS を選択します。

```{r}
BRICS <- c("Brazil", "Russian Federation", "India", "China", "South Africa")
```

### 経年変化

### a. 日本

```{r}
df_w6_1 |> drop_na(co2pcap) |> filter(country == "Japan") |>
  ggplot(aes(year, co2pcap)) + geom_line() + 
  labs(title = "日本の一人当たりの二酸化炭素排出量")
```

```{r}
df_w6_1 |> drop_na(forest) |> filter(country == "Japan") |>
  ggplot(aes(year, forest)) + geom_line() + 
  labs(title = "日本の森林面積（％）")
```

### b. 選択した国・地域

```{r}
df_w6_1 |> drop_na(co2pcap) |> filter(country %in% BRICS) |>
  ggplot(aes(year, co2pcap, col = country)) + geom_line() + 
  labs(title = "BRICS の一人当たりの二酸化炭素排出量")
```

```{r}
df_w6_1 |> drop_na(forest) |> filter(country %in% BRICS) |>
  ggplot(aes(year, forest, col = country)) + geom_line() + 
  labs(title = "BRICSの森林面積（％）")
```

### 二つのデータの散布図

必要に応じて log10 スケール

#### a. すべての値の散布図

```{r}
df_w6_1 |> ggplot(aes(forest, co2pcap, col = region)) + geom_point()
```

#### b. NA ではない値の散布図、近似（回帰）直線を表示

```{r}
df_w6_1 |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

#### c. 地域を除き国のみの散布図、近似（回帰）直線を表示

```{r}
df_w6_1 |> filter(!(iso2c %in% REGION)) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

#### d. 最近の年を選択し、地域を除き国のもの散布図、近似（回帰）直線を表示

```{r}
df_w6_1 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  ggplot(aes(forest, co2pcap)) + geom_point(aes(col = region)) +
  geom_smooth(formula = 'y~x', method = "lm", se = FALSE)
```

**気づいたこと・疑問**

-   森林面積が10％ よりも少ない国が多い

-   弱い負の相関があるようだ

-   授業で求めた相関係数は、-0.1832374。これは、四つの指標すべての値があり（NA ではなく）国地域も分けず、すべての年のデータでの相関をとったもの。傾向はある程度わかる。

```{r}
df_w6_1 |> filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> drop_na(co2pcap, forest) |> 
  select(co2pcap, forest) |> cor() 
```
