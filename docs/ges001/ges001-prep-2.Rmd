---
title: "GES 001 演習2"
author: "H. Suzuki"
date: "`r Sys.Date()`"
output:
  html_notebook: default
---

## 第2週

12/14(TH)　所得と富の不平等の現状１

　　　　　  所得と富の不平等の現状２

講義では、第2週、第3週とWorld Inequality report 2022を使って、所得と富の不平等について議論します。

12/19(TU)　Rでデータサイエンス2：人口の少子高齢化　 [[Main](https://ds-sl.github.io/intro2r/ges001/ges001-main.nb.html)]・[授業]

**People- Population dynamics**

総人口　Population, total：SP.POP.TOTL [[Link](https://data.worldbank.org/indicator/SP.POP.TOTL)]

出生率（千人）Birth rate, crude (per 1,000 people)：SP.DYN.CBRT.IN [[Link](https://data.worldbank.org/indicator/SP.DYN.CBRT.IN)]

死亡率（千人）Death rate, crude (per 1,000 people)：SP.DYN.CDRT.IN [[Link](https://data.worldbank.org/indicator/SP.DYN.CDRT.IN)]

若年労働人口率　Age dependency ratio, young (% of working-age population)：SP.POP.DPND.YG [[Link](https://data.worldbank.org/indicator/SP.POP.DPND.YG)]

高齢者労働人口率　Age dependency ratio, old (% of working-age population)：SP.POP.DPND.OL [[Link to Metadata](https://databank.worldbank.org/metadataglossary/health-nutrition-and-population-statistics/series/SP.POP.DPND.OL)]

## 内容

-   Package：tidyverse, WDI

-   データの取得

-   特定の行の取得：filter

-   折れ線グラフ

-   散布図

### トピック：人口の少子高齢化

```{r}
library(tidyverse)
library(WDI)
```

```{r eval = FALSE}
df_pop <- WDI(indicator = c(pop = "SP.POP.TOTL",
                            birth_rate = "SP.DYN.CBRT.IN",
                            death_rate = "SP.DYN.CDRT.IN",
                            young = "SP.POP.DPND.YG",
                            old = "SP.POP.DPND.OL"))
```

```{r eval = FALSE}
write_csv(df_pop, "data/pop.csv")
```

```{r}
df_pop <- read_csv("data/pop.csv")
```

```{r}
df_pop
```

#### それぞれ十分なデータがあるかチェック

```{r}
df_pop_long <- df_pop |> 
  pivot_longer(5:9, names_to = "name", values_to = "value")
```

```{r}
df_pop_long |> 
  group_by(year, name) |> drop_na(value) |>
  summarize(num = n()) |> arrange(desc(year))
```

```{r}
df_pop_long |> 
  group_by(year, name) |> drop_na(value) |>
  summarize(num = n()) |> 
  ggplot(aes(year, num, col = name)) + geom_line() +
  labs(title = "各指標の年毎のデータ数", y = "データ数", x = "年")
```

253から265の国・地域のデータがあり、問題なし

```{r eval = FALSE}
df_pop_extra <- WDI(indicator = c(pop = "SP.POP.TOTL",
                            birth_rate = "SP.DYN.CBRT.IN",
                            death_rate = "SP.DYN.CDRT.IN",
                            young = "SP.POP.DPND.YG",
                            old = "SP.POP.DPND.OL"), extra = TRUE)
```

```{r eval = FALSE}
write_csv(df_pop_extra, "data/pop_extra.csv")
```

```{r}
df_pop_extra <- read_csv("data/pop_extra.csv")
```

```{r}
str(df_pop_extra)
```

```{r}
glimpse(df_pop_extra)
```

いくつかの文字ベクトルの内容確認

```{r}
df_pop_extra |> select(region, income, lending, status) |> lapply(unique)
```

```{r}
REGION <- df_pop_extra |> filter(region %in% c("Aggregates", NA)) |> distinct(iso2c) |> pull()
length(REGION)
```

#### 他の指定の仕方と比較

```{r}
REGION1 <- df_pop_extra |> filter(region %in% c("Aggregates")) |> distinct(iso2c) |> pull()
length(REGION1)
```

```{r}
df_pop_extra |> filter(region == "Aggregates") |> distinct(iso2c) |> pull() |> identical(REGION1)
```

```{r}
df_pop %>% filter(iso2c %in% REGION) %>% distinct(country, iso2c)
```

Czechia, CZ, Not classified, Viet Nam, VN

```{r}
df_pop_extra |> distinct(country, iso2c)
```

```{r}
df_pop_extra |> filter(iso2c %in% c("CZ","VN"))
```

```{r}
length(REGION)
REGION <- REGION[!(REGION %in% c("CZ","VN"))] |> sort()
length(REGION)
REGION
```

```{r}
df_pop |> filter(iso2c %in% REGION) |> distinct(country, iso2c)
```

```{r}
df_pop |> filter(!(iso2c %in% REGION)) |> 
  distinct(country, iso2c) |> arrange(country)
```

```{r}
dput(REGION)
length(REGION)
```

```{r}
df_pop_extra |> filter(!(iso2c %in% REGION)) |> 
  select(region, income, lending, status) |> lapply(unique)
```

```{r}
df_pop_extra |> filter(!(iso2c %in% REGION)) |> 
  select(region, income, lending, status) |> lapply(unique) |> dput()
```

```{r}
df_pop_extra |> filter(!(iso2c %in% REGION)) |> 
  filter(is.na(region)) |> distinct(country, iso2c)
```

```{r}
df_pop_extra |> filter(!(iso2c %in% REGION)) |> 
  filter(income %in% c("Not classified", NA)) |> distinct(country, iso2c, income)
```

```{r}
df_pop_extra |> filter(!(iso2c %in% REGION)) |> 
  filter(lending %in% c("Not classified", NA)) |> distinct(country, iso2c, lending)
```

World Bank Country and Lending Groups [[Link](https://datahelpdesk.worldbank.org/knowledgebase/articles/906519-world-bank-country-and-lending-groups)]

How does the World Bank classify countries? [[Link](https://datahelpdesk.worldbank.org/knowledgebase/articles/378834-how-does-the-world-bank-classify-countries)]

World Bank Group country classifications by income level for FY24 (July 1, 2023- June 30, 2024) [[Link](https://blogs.worldbank.org/opendata/new-world-bank-group-country-classifications-income-level-fy24)]

**Operational lending categories**

Economies are also divided into IDA, IBRD, and Blend categories based on the [operational policies](https://policies.worldbank.org/sites/ppf3/Pages/Manuals/Operational%20Manual.aspx "Link: https://policies.worldbank.org/sites/ppf3/Pages/Manuals/Operational%20Manual.aspx") of the World Bank.[ ](http://ida.worldbank.org/about/what-ida)[International Development Association ](http://ida.worldbank.org/about/what-ida "Link: http://ida.worldbank.org/about/what-ida")(IDA) countries are those with low per capita incomes that lack the financial ability to borrow from the [International Bank for Reconstruction and Development](http://go.worldbank.org/SDUHVGE5S0 "Link: http://go.worldbank.org/SDUHVGE5S0") (IBRD). Blend countries are eligible for IDA loans but are also eligible for IBRD loans because they are financially creditworthy.

```{r}
df_pop_extra |> filter(country == "China") |> select(country, year, income, lending)
```

### 総人口

総人口　Population, total：SP.POP.TOTL [[Link](https://data.worldbank.org/indicator/SP.POP.TOTL)]

```{r}
df_pop |> filter(country == "World") |> 
  ggplot(aes(year, pop)) + geom_line() + 
  labs(title = "世界の人口")
```

```{r}
df_pop |> filter(country == "Japan") |> 
  ggplot(aes(year, pop)) + geom_line() +
  labs(title = "日本の人口")
```

```{r}
COUNTRY <- "Germany"
df_pop |> filter(country == "France") |> 
  ggplot(aes(year, pop)) + geom_line() +
  labs(title = "ドイツの人口")
```

```{r}
df_pop |> filter(!(iso2c %in% REGION)) |> filter(year == 2022) |> 
  arrange(desc(pop))
```

```{r}
df_pop |> filter(!(iso2c %in% REGION)) |> filter(year == 2022) |> 
  arrange(desc(pop)) |> slice_head(n=10)
```

```{r}
pop_top11 <- df_pop |> filter(!(iso2c %in% REGION)) |> filter(year == 2022) |> 
  arrange(desc(pop)) |> slice_head(n=11) |> pull(iso2c)
pop_top11
dput(pop_top11)
```

```{r}
df_pop |> filter(iso2c %in% pop_top11) |>
  ggplot(aes(year, pop, color = iso2c)) + geom_line()
```

```{r}
df_pop |> filter(country %in% c("South Asia", "Europe & Central Asia", "Middle East & North Africa", 
"East Asia & Pacific", "Sub-Saharan Africa", "Latin America & Caribbean", "North America")) |>
  ggplot(aes(year, pop, color = country)) + geom_line()
```

```{r}
df_pop |> filter(country %in% c("South Asia", "Europe & Central Asia", "Middle East & North Africa", 
"East Asia & Pacific", "Sub-Saharan Africa", "Latin America & Caribbean", "North America")) |> 
  distinct(iso2c) |> pull() |> dput()
```

```{r}
df_pop |> filter(country %in% c("South Asia", "Europe & Central Asia", "Middle East & North Africa", 
"East Asia & Pacific", "Sub-Saharan Africa", "Latin America & Caribbean", "North America")) |> filter(year == 2022) |> arrange(desc(pop))
```

```{r}
df_pop |> filter(iso2c %in% pop_top11) |> 
  filter(!(iso2c %in% c("CN", "IN"))) |> 
  ggplot(aes(year, pop, color = country)) + geom_line()
```

```{r}
df_pop |> filter(iso2c %in% pop_top11) |> 
  filter(!(iso2c %in% c("CN", "IN"))) |> 
  ggplot(aes(year, pop, color = factor(iso2c, levels = pop_top11))) + geom_line() + labs(color = "iso2c")
```

### 出生率と死亡率

出生率（千人）Birth rate, crude (per 1,000 people)：SP.DYN.CBRT.IN [[Link](https://data.worldbank.org/indicator/SP.DYN.CBRT.IN)]

死亡率（千人）Death rate, crude (per 1,000 people)：SP.DYN.CDRT.IN [[Link](https://data.worldbank.org/indicator/SP.DYN.CDRT.IN)]

```{r}
df_pop_long |> filter(name %in% c("birth_rate", "death_rate")) |>
  filter(country == "World") |> 
  ggplot(aes(year, value, col = name)) + geom_line()
```

```{r}
df_pop_long |> filter(name %in% c("birth_rate", "death_rate")) |>
  filter(iso2c %in% c("BD", "BR", "CN", "ID", "NG", "JP")) |> 
  ggplot(aes(year, value, col = country, linetype = name)) + 
  geom_line()
```

```{r}
df_pop_long |> filter(name %in% c("birth_rate", "death_rate")) |>
  filter(iso2c %in% c("Z4", "Z7", "ZJ", "ZQ", "XU", "8S", "ZG")) |> 
  ggplot(aes(year, value, col = country, linetype = name)) + 
  geom_line()
```

```{r}
df_pop_extra |> 
  filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> 
  filter(!(income %in% c(NA, "Not classified"))) |>
  drop_na(birth_rate, death_rate) |>
  ggplot(aes(birth_rate,death_rate,col=income)) + geom_point()
```

```{r}
df_pop_extra |> 
  filter(!(iso2c %in% REGION)) |> 
  filter(year %in% c(1960, 1990, 2020)) |> 
  filter(!(income %in% c(NA, "Not classified"))) |>
  drop_na(birth_rate, death_rate) |>
  ggplot(aes(birth_rate,death_rate,col=income)) + geom_point() + 
  facet_wrap(~ year) + theme(legend.position = "bottom") +
  labs(col = "")
```

Google Public Data Explorer: [Link](https://www.google.com/publicdata/explore?ds=d5bncppjof8f9_&ctype=b&strail=false&bcs=d&nselm=s&met_y=sp_dyn_cdrt_in&scale_y=lin&ind_y=false&met_x=SP_DYN_CBRT_IN&scale_x=lin&ind_x=false&dimp_c=country:region&ifdim=country&tunit=Y&pit=1512486000000&ind=false&icfg)

### 扶養家族の労働人口に対する割合

若年労働人口率　Age dependency ratio, young (% of working-age population)：SP.POP.DPND.YG [[Link](https://data.worldbank.org/indicator/SP.POP.DPND.YG)]

Age dependency ratio, young, is the ratio of younger dependents--people younger than 15--to the working-age population--those ages 15-64. Data are shown as the proportion of dependents per 100 working-age population.

年齢別扶養比率（若年）は、15歳未満の扶養家族の、15歳から64歳までの生産年齢人口に対する比率である。データは、生産年齢人口100人当たりの扶養家族の割合で示されている。

高齢者労働人口率　Age dependency ratio, old (% of working-age population)：SP.POP.DPND.OL [[Link to Metadata](https://databank.worldbank.org/metadataglossary/health-nutrition-and-population-statistics/series/SP.POP.DPND.OL)]

Age dependency ratio, old, is the ratio of older dependents--people older than 64--to the working-age population--those ages 15-64. Data are shown as the proportion of dependents per 100 working-age population.

年齢別扶養比率（高齢）は、生産年齢人口（15～64歳）に対する高齢扶養家族（64歳以上）の比率。データは、生産年齢人口100人当たりの扶養家族の割合で示されている。

```{r}
df_pop_long |> filter(name %in% c("young", "old")) |>
  filter(country == "World") |> 
  ggplot(aes(year, value, col = name)) + geom_line()
```

```{r}
df_pop_long |> filter(name %in% c("young", "old")) |>
  filter(iso2c %in% c("BD", "BR", "CN", "ID", "NG", "JP")) |> 
  ggplot(aes(year, value, col = country, linetype = name)) + 
  geom_line()
```

```{r}
df_pop_extra |> 
  filter(!(iso2c %in% REGION)) |> filter(year == 2020) |> 
  filter(!(income %in% c(NA, "Not classified"))) |>
  drop_na(young, old) |>
  ggplot(aes(young, old, col=income)) + geom_point()
```

```{r}
df_pop_extra |> 
  filter(region == "Sub-Saharan Africa") |> filter(year == 2020) |> 
  drop_na(young, old) |>
  ggplot(aes(young, old, col=income)) + geom_point()
```

```{r}
df_pop_long |> filter(name %in% c("young", "old")) |>
  filter(iso2c %in% c("US", "GB", "CN", "DE", "FR", "JP", "IN")) |> 
  ggplot(aes(year, value, col = country, linetype = name)) + 
  geom_line()
```

```{r}
df_pop_long |> filter(name %in% c("young", "old")) |>
  filter(country %in% c("South Asia", "Europe & Central Asia", "Middle East & North Africa", 
"East Asia & Pacific", "Sub-Saharan Africa", "Latin America & Caribbean", "North America")) |> 
  ggplot(aes(year, value, col = country, linetype = name)) + 
  geom_line() + labs(title = "地域別の労働人口に対する高齢・若年扶養率（％）", 
       subtitle = "実線：高齢者、点線：若年者", x = "", col = "", linetype = "")
```

```{r fig.height=7, fig.width=7}
df_pop_long |> filter(name %in% c("young", "old")) |>
  filter(country %in% c("South Asia", "Europe & Central Asia", "Middle East & North Africa", 
"East Asia & Pacific", "Sub-Saharan Africa", "Latin America & Caribbean", "North America")) |> 
  ggplot(aes(year, value, col = country, linetype = name)) + 
  geom_line() + facet_wrap(~country) + theme(legend.position = "none") +
  labs(title = "地域別の労働人口に対する高齢・若年扶養率（％）", 
       subtitle = "実線：高齢者、点線：若年者", x = "", y = "")
```

Default is **fig.** **width = 7 and fig.** **height = 5**

```{r}
df_pop_long |> filter(name %in% c("young", "old")) |>
  filter(country %in% c("South Asia", "Europe & Central Asia", "Middle East & North Africa", 
"East Asia & Pacific", "Sub-Saharan Africa", "Latin America & Caribbean", "North America")) |> 
  ggplot(aes(year, value, col = country, linetype = name)) + 
  geom_line() + facet_wrap(~country, 2,4) + theme(legend.position = "none") +
  labs(title = "地域別の労働人口に対する高齢・若年扶養率（％）", 
       subtitle = "実線：高齢者、点線：若年者", x = "", y = "")
```
